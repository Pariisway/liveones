<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard | Whisper+Me</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Montserrat:wght@800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    
    <style>
        .admin-page {
            padding-top: 100px;
            min-height: 100vh;
            background: linear-gradient(135deg, #0a0a0a 0%, #151515 100%);
        }
        
        .admin-header {
            text-align: center;
            margin-bottom: 40px;
        }
        
        .admin-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 30px;
            margin-bottom: 40px;
        }
        
        .admin-card {
            background: var(--card-bg);
            border-radius: var(--radius-lg);
            padding: 30px;
        }
        
        .admin-card.danger {
            border-left: 4px solid var(--error);
        }
        
        .admin-card.warning {
            border-left: 4px solid var(--warning);
        }
        
        .admin-card.success {
            border-left: 4px solid var(--success);
        }
        
        .admin-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        .admin-table th {
            background: rgba(108, 99, 255, 0.1);
            color: var(--primary);
            padding: 15px;
            text-align: left;
            border-bottom: 2px solid rgba(108, 99, 255, 0.3);
        }
        
        .admin-table td {
            padding: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .admin-table tr:hover {
            background: rgba(255, 255, 255, 0.05);
        }
        
        .badge {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .badge.success {
            background: rgba(46, 204, 113, 0.2);
            color: var(--success);
        }
        
        .badge.warning {
            background: rgba(241, 196, 15, 0.2);
            color: var(--warning);
        }
        
        .badge.danger {
            background: rgba(231, 76, 60, 0.2);
            color: var(--error);
        }
        
        .badge.info {
            background: rgba(52, 152, 219, 0.2);
            color: var(--info);
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
        }
        
        .btn-sm {
            padding: 8px 15px;
            font-size: 0.9rem;
        }
        
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding-bottom: 10px;
        }
        
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border-radius: var(--radius);
            transition: var(--transition);
        }
        
        .tab.active {
            background: var(--primary);
        }
        
        .tab:hover:not(.active) {
            background: rgba(255, 255, 255, 0.05);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .email-preview {
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: var(--radius);
            margin-top: 20px;
            font-family: monospace;
            white-space: pre-wrap;
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-brand">
                <i class="fas fa-comment-dots"></i>
                <span>Whisper+Me</span>
            </div>
            
            <div class="nav-menu">
                <a href="index.html" class="nav-link">Home</a>
                <a href="index.html#whispers" class="nav-link">Whispers</a>
                <a href="payment.html" class="nav-link">Buy Coins</a>
                <a href="enhanced-dashboard.html" class="nav-link">User Dashboard</a>
                <a href="admin-dashboard.html" class="nav-link active">Admin Dashboard</a>
            </div>
            
            <div class="nav-actions">
                <span id="userNav" class="nav-user">Admin</span>
                <button id="logoutBtn" class="btn-outline">Log Out</button>
            </div>
            
            <button class="mobile-menu-btn">
                <i class="fas fa-bars"></i>
            </button>
        </div>
    </nav>

    <div class="admin-page">
        <div class="container">
            <div class="admin-header">
                <h1>Admin Dashboard</h1>
                <p style="color: var(--text-gray); font-size: 1.2rem;">Manage your platform and review disputes</p>
            </div>
            
            <!-- Admin Only Warning -->
            <div id="adminWarning" style="text-align: center; padding: 40px;">
                <div class="loading-spinner" style="width: 50px; height: 50px; border: 3px solid var(--primary); border-top-color: transparent; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px;"></div>
                <p>Checking admin permissions...</p>
            </div>
            
            <!-- Admin Content (hidden until verified) -->
            <div id="adminContent" style="display: none;">
                <!-- Stats Overview -->
                <div class="admin-grid">
                    <div class="admin-card success">
                        <h3><i class="fas fa-users"></i> Total Users</h3>
                        <div class="card-value" id="totalUsers">0</div>
                        <p style="color: var(--text-gray);">Active on platform</p>
                    </div>
                    
                    <div class="admin-card info">
                        <h3><i class="fas fa-phone-alt"></i> Total Calls</h3>
                        <div class="card-value" id="totalCalls">0</div>
                        <p style="color: var(--text-gray);">Completed conversations</p>
                    </div>
                    
                    <div class="admin-card warning">
                        <h3><i class="fas fa-exclamation-triangle"></i> Pending Disputes</h3>
                        <div class="card-value" id="pendingDisputes">0</div>
                        <p style="color: var(--text-gray);">Need review</p>
                    </div>
                    
                    <div class="admin-card">
                        <h3><i class="fas fa-coins"></i> Platform Revenue</h3>
                        <div class="card-value" id="platformRevenue">$0</div>
                        <p style="color: var(--text-gray);">30-day total</p>
                    </div>
                </div>
                
                <!-- Tabs -->
                <div class="tabs">
                    <div class="tab active" data-tab="disputes">Disputes</div>
                    <div class="tab" data-tab="users">User Management</div>
                    <div class="tab" data-tab="calls">Call Logs</div>
                    <div class="tab" data-tab="email">Email Tools</div>
                </div>
                
                <!-- Disputes Tab -->
                <div class="tab-content active" id="disputesTab">
                    <div class="admin-card">
                        <h2><i class="fas fa-gavel"></i> Dispute Management</h2>
                        <p style="color: var(--text-gray); margin-bottom: 20px;">
                            Review and resolve user disputes. All disputes are CC'd to ifanifwasafifth@gmail.com
                        </p>
                        
                        <div id="disputesList">
                            <div style="text-align: center; padding: 40px; color: var(--text-gray);">
                                <i class="fas fa-inbox" style="font-size: 3rem; margin-bottom: 20px;"></i>
                                <h3>No disputes yet</h3>
                                <p>When users submit disputes, they'll appear here.</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Users Tab -->
                <div class="tab-content" id="usersTab">
                    <div class="admin-card">
                        <h2><i class="fas fa-user-cog"></i> User Management</h2>
                        
                        <table class="admin-table">
                            <thead>
                                <tr>
                                    <th>User ID</th>
                                    <th>Name</th>
                                    <th>Email</th>
                                    <th>Role</th>
                                    <th>Coins</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="usersList">
                                <tr>
                                    <td colspan="7" style="text-align: center; padding: 40px; color: var(--text-gray);">
                                        Loading users...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Calls Tab -->
                <div class="tab-content" id="callsTab">
                    <div class="admin-card">
                        <h2><i class="fas fa-history"></i> Call History</h2>
                        
                        <table class="admin-table">
                            <thead>
                                <tr>
                                    <th>Call ID</th>
                                    <th>Caller</th>
                                    <th>Whisper</th>
                                    <th>Duration</th>
                                    <th>Cost</th>
                                    <th>Status</th>
                                    <th>Date</th>
                                </tr>
                            </thead>
                            <tbody id="callsList">
                                <tr>
                                    <td colspan="7" style="text-align: center; padding: 40px; color: var(--text-gray);">
                                        Loading calls...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Email Tab -->
                <div class="tab-content" id="emailTab">
                    <div class="admin-card">
                        <h2><i class="fas fa-envelope"></i> Email Notification Tool</h2>
                        <p style="color: var(--text-gray); margin-bottom: 20px;">
                            Send emails to users. CC: ifanifwasafifth@gmail.com
                        </p>
                        
                        <div class="form-group">
                            <label for="emailUser">Select User</label>
                            <select id="emailUser" class="form-control">
                                <option value="">Loading users...</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="emailSubject">Subject</label>
                            <input type="text" id="emailSubject" class="form-control" placeholder="Important announcement...">
                        </div>
                        
                        <div class="form-group">
                            <label for="emailMessage">Message</label>
                            <textarea id="emailMessage" class="form-control" rows="6" placeholder="Type your message..."></textarea>
                        </div>
                        
                        <div class="email-preview" id="emailPreview">
                            <strong>Email Preview:</strong><br><br>
                            <strong>To:</strong> user@example.com<br>
                            <strong>CC:</strong> ifanifwasafifth@gmail.com<br>
                            <strong>Subject:</strong> [Whisper+Me] Your Subject Here<br><br>
                            Message will appear here...
                        </div>
                        
                        <button class="btn-primary" onclick="sendAdminEmail()" style="margin-top: 20px;">
                            <i class="fas fa-paper-plane"></i> Send Email (Simulated)
                        </button>
                        
                        <p style="color: var(--text-gray); font-size: 0.9rem; margin-top: 15px;">
                            <i class="fas fa-info-circle"></i> Note: This simulates email sending. For real emails, integrate with EmailJS or similar service.
                        </p>
                    </div>
                </div>
                
                <!-- Quick Actions -->
                <div class="admin-card" style="margin-top: 30px;">
                    <h2>Quick Admin Actions</h2>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 20px;">
                        <button class="btn-outline" onclick="addCoinsToUser()">
                            <i class="fas fa-coins"></i> Add Coins to User
                        </button>
                        <button class="btn-outline" onclick="toggleUserStatus()">
                            <i class="fas fa-user-slash"></i> Suspend User
                        </button>
                        <button class="btn-outline" onclick="viewSystemLogs()">
                            <i class="fas fa-terminal"></i> System Logs
                        </button>
                        <button class="btn-outline" onclick="exportData()">
                            <i class="fas fa-download"></i> Export Data
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for dispute details -->
    <div class="modal" id="disputeModal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h3>Dispute Details</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body" id="disputeDetails">
                Loading...
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    
    <script src="firebase-config.js"></script>
    <script src="scripts.js"></script>
    
    <script>
        // Admin UIDs - add your user IDs here
        const ADMIN_UIDS = [
            'u3x8n3kY7QMWK8cVtXanL3FOIqo1',  // Your main account
            'V6NQDDxrokU2xCmCfmuPziMoXv82'   // Your other account from logs
        ];
        
        // Admin email for CC
        const ADMIN_EMAIL = 'ifanifwasafifth@gmail.com';
        
        async function checkAdminAccess() {
            if (!currentUser) {
                showToast('Please log in to access admin panel', 'error');
                setTimeout(() => window.location.href = 'index.html', 1500);
                return false;
            }
            
            if (!ADMIN_UIDS.includes(currentUser.uid)) {
                document.getElementById('adminWarning').innerHTML = `
                    <div style="text-align: center; padding: 40px;">
                        <i class="fas fa-exclamation-triangle" style="font-size: 3rem; color: var(--warning); margin-bottom: 20px;"></i>
                        <h3>Access Denied</h3>
                        <p>You don't have permission to access the admin dashboard.</p>
                        <a href="enhanced-dashboard.html" class="btn-primary" style="margin-top: 20px;">
                            <i class="fas fa-arrow-left"></i> Go to User Dashboard
                        </a>
                    </div>
                `;
                return false;
            }
            
            // User is admin
            document.getElementById('adminWarning').style.display = 'none';
            document.getElementById('adminContent').style.display = 'block';
            
            // Load admin data
            loadAdminData();
            
            return true;
        }
        
        async function loadAdminData() {
            try {
                // Load users
                const usersSnapshot = await db.collection('users').limit(50).get();
                const users = usersSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                // Load calls
                const callsSnapshot = await db.collection('calls').limit(50).get();
                const calls = callsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                // Load disputes
                const disputesSnapshot = await db.collection('disputes').where('status', '==', 'pending').get();
                const disputes = disputesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                // Update stats
                document.getElementById('totalUsers').textContent = users.length;
                document.getElementById('totalCalls').textContent = calls.length;
                document.getElementById('pendingDisputes').textContent = disputes.length;
                
                // Calculate revenue (simplified)
                const revenue = calls.reduce((sum, call) => sum + (call.cost || 0), 0);
                document.getElementById('platformRevenue').textContent = `$${revenue.toFixed(2)}`;
                
                // Populate users table
                populateUsersTable(users);
                
                // Populate calls table
                populateCallsTable(calls);
                
                // Populate disputes
                populateDisputes(disputes);
                
                // Populate email user dropdown
                populateEmailUsers(users);
                
            } catch (error) {
                console.error('Error loading admin data:', error);
                showToast('Error loading admin data: ' + error.message, 'error');
            }
        }
        
        function populateUsersTable(users) {
            const tbody = document.getElementById('usersList');
            let html = '';
            
            users.forEach(user => {
                const status = user.isSuspended ? 'danger' : 'success';
                const statusText = user.isSuspended ? 'Suspended' : 'Active';
                
                html += `
                    <tr>
                        <td style="font-family: monospace; font-size: 0.9rem;">${user.id.substring(0, 8)}...</td>
                        <td>${user.displayName || 'N/A'}</td>
                        <td>${user.email || 'N/A'}</td>
                        <td><span class="badge ${user.role === 'whisper' ? 'info' : ''}">${user.role || 'caller'}</span></td>
                        <td>${user.coins || 0}</td>
                        <td><span class="badge ${status}">${statusText}</span></td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn-outline btn-sm" onclick="viewUser('${user.id}')">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn-outline btn-sm" onclick="editUser('${user.id}')">
                                    <i class="fas fa-edit"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = html || '<tr><td colspan="7" style="text-align: center;">No users found</td></tr>';
        }
        
        function populateCallsTable(calls) {
            const tbody = document.getElementById('callsList');
            let html = '';
            
            calls.forEach(call => {
                const startTime = call.startTime ? call.startTime.toDate() : new Date();
                const duration = call.duration || 0;
                const minutes = Math.floor(duration / 60);
                const seconds = duration % 60;
                
                html += `
                    <tr>
                        <td style="font-family: monospace; font-size: 0.9rem;">${call.id.substring(0, 8)}...</td>
                        <td>${call.callerId ? call.callerId.substring(0, 8) + '...' : 'N/A'}</td>
                        <td>${call.whisperId ? call.whisperId.substring(0, 8) + '...' : 'N/A'}</td>
                        <td>${minutes}:${seconds.toString().padStart(2, '0')}</td>
                        <td>${call.cost || 0} coin${call.cost !== 1 ? 's' : ''}</td>
                        <td><span class="badge ${call.status === 'completed' ? 'success' : 'warning'}">${call.status || 'unknown'}</span></td>
                        <td>${startTime.toLocaleDateString()}</td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = html || '<tr><td colspan="7" style="text-align: center;">No calls found</td></tr>';
        }
        
        function populateDisputes(disputes) {
            const container = document.getElementById('disputesList');
            
            if (disputes.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--text-gray);">
                        <i class="fas fa-inbox" style="font-size: 3rem; margin-bottom: 20px;"></i>
                        <h3>No pending disputes</h3>
                        <p>When users submit disputes, they'll appear here.</p>
                        <button class="btn-primary" onclick="createTestDispute()" style="margin-top: 20px;">
                            <i class="fas fa-plus"></i> Create Test Dispute
                        </button>
                    </div>
                `;
                return;
            }
            
            let html = '<div style="display: grid; gap: 15px;">';
            
            disputes.forEach(dispute => {
                const time = dispute.createdAt ? dispute.createdAt.toDate() : new Date();
                
                html += `
                    <div style="background: rgba(255, 255, 255, 0.05); padding: 20px; border-radius: var(--radius);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <div>
                                <h4 style="margin: 0;">${dispute.subject || 'No Subject'}</h4>
                                <p style="color: var(--text-gray); margin: 5px 0 0 0; font-size: 0.9rem;">
                                    From: ${dispute.userEmail || 'Unknown'} â€¢ ${time.toLocaleString()}
                                </p>
                            </div>
                            <span class="badge warning">Pending</span>
                        </div>
                        <p style="margin-bottom: 15px;">${dispute.message || 'No message provided.'}</p>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn-primary btn-sm" onclick="resolveDispute('${dispute.id}')">
                                <i class="fas fa-check"></i> Resolve
                            </button>
                            <button class="btn-outline btn-sm" onclick="viewDisputeDetails('${dispute.id}')">
                                <i class="fas fa-search"></i> Details
                            </button>
                            <button class="btn-outline btn-sm" onclick="emailUser('${dispute.userId}', '${dispute.userEmail}')">
                                <i class="fas fa-envelope"></i> Email User
                            </button>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
        }
        
        function populateEmailUsers(users) {
            const select = document.getElementById('emailUser');
            let html = '<option value="">Select a user...</option>';
            
            users.forEach(user => {
                html += `<option value="${user.id}" data-email="${user.email}">${user.displayName || user.email} (${user.role})</option>`;
            });
            
            select.innerHTML = html;
            
            // Update preview when selection changes
            select.addEventListener('change', updateEmailPreview);
            document.getElementById('emailSubject').addEventListener('input', updateEmailPreview);
            document.getElementById('emailMessage').addEventListener('input', updateEmailPreview);
        }
        
        function updateEmailPreview() {
            const userSelect = document.getElementById('emailUser');
            const selectedOption = userSelect.options[userSelect.selectedIndex];
            const userEmail = selectedOption ? selectedOption.getAttribute('data-email') : 'user@example.com';
            const subject = document.getElementById('emailSubject').value || 'Your Subject Here';
            const message = document.getElementById('emailMessage').value || 'Message will appear here...';
            
            document.getElementById('emailPreview').innerHTML = `
                <strong>Email Preview:</strong><br><br>
                <strong>To:</strong> ${userEmail}<br>
                <strong>CC:</strong> ${ADMIN_EMAIL}<br>
                <strong>Subject:</strong> [Whisper+Me] ${subject}<br><br>
                ${message.replace(/\n/g, '<br>')}
            `;
        }
        
        // Tab switching
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', function() {
                const tabId = this.getAttribute('data-tab');
                
                // Update active tab
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                this.classList.add('active');
                
                // Update active content
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                document.getElementById(tabId + 'Tab').classList.add('active');
            });
        });
        
        // Modal closing
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('modal') || e.target.classList.contains('modal-close')) {
                document.querySelectorAll('.modal').forEach(modal => {
                    modal.classList.remove('active');
                });
            }
        });
        
        // Admin functions
        async function createTestDispute() {
            if (!currentUser) return;
            
            try {
                await db.collection('disputes').add({
                    userId: currentUser.uid,
                    userEmail: currentUser.email,
                    subject: 'Test Dispute',
                    message: 'This is a test dispute to show how the system works.',
                    status: 'pending',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    adminNote: 'Test dispute created by admin'
                });
                
                showToast('Test dispute created', 'success');
                loadAdminData(); // Refresh
                
            } catch (error) {
                console.error('Error creating test dispute:', error);
                showToast('Error: ' + error.message, 'error');
            }
        }
        
        async function resolveDispute(disputeId) {
            if (!confirm('Mark this dispute as resolved?')) return;
            
            try {
                await db.collection('disputes').doc(disputeId).update({
                    status: 'resolved',
                    resolvedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    resolvedBy: currentUser.uid
                });
                
                showToast('Dispute resolved', 'success');
                loadAdminData(); // Refresh
                
            } catch (error) {
                console.error('Error resolving dispute:', error);
                showToast('Error: ' + error.message, 'error');
            }
        }
        
        async function viewDisputeDetails(disputeId) {
            try {
                const doc = await db.collection('disputes').doc(disputeId).get();
                
                if (doc.exists) {
                    const dispute = doc.data();
                    const modal = document.getElementById('disputeModal');
                    const details = document.getElementById('disputeDetails');
                    
                    details.innerHTML = `
                        <div style="margin-bottom: 20px;">
                            <h4>${dispute.subject || 'No Subject'}</h4>
                            <p style="color: var(--text-gray);">
                                From: ${dispute.userEmail || 'Unknown'}<br>
                                User ID: ${dispute.userId || 'N/A'}<br>
                                Created: ${dispute.createdAt ? dispute.createdAt.toDate().toLocaleString() : 'Unknown'}
                            </p>
                        </div>
                        
                        <div style="background: rgba(255, 255, 255, 0.05); padding: 20px; border-radius: var(--radius); margin-bottom: 20px;">
                            <h5>Message:</h5>
                            <p>${dispute.message || 'No message'}</p>
                        </div>
                        
                        <div style="background: rgba(255, 255, 255, 0.05); padding: 20px; border-radius: var(--radius); margin-bottom: 20px;">
                            <h5>Admin Notes:</h5>
                            <textarea id="adminNotes" style="width: 100%; height: 100px; padding: 10px; background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: var(--radius); color: white; margin-top: 10px;">${dispute.adminNote || ''}</textarea>
                        </div>
                        
                        <div style="display: flex; gap: 10px;">
                            <button class="btn-primary" onclick="saveAdminNotes('${disputeId}')">
                                <i class="fas fa-save"></i> Save Notes
                            </button>
                            <button class="btn-outline" onclick="closeModal()">
                                <i class="fas fa-times"></i> Close
                            </button>
                        </div>
                    `;
                    
                    modal.classList.add('active');
                }
            } catch (error) {
                console.error('Error viewing dispute:', error);
                showToast('Error loading dispute details', 'error');
            }
        }
        
        async function saveAdminNotes(disputeId) {
            const notes = document.getElementById('adminNotes').value;
            
            try {
                await db.collection('disputes').doc(disputeId).update({
                    adminNote: notes,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                showToast('Notes saved', 'success');
                
            } catch (error) {
                console.error('Error saving notes:', error);
                showToast('Error saving notes', 'error');
            }
        }
        
        function sendAdminEmail() {
            const userSelect = document.getElementById('emailUser');
            const selectedOption = userSelect.options[userSelect.selectedIndex];
            const userEmail = selectedOption ? selectedOption.getAttribute('data-email') : null;
            const subject = document.getElementById('emailSubject').value;
            const message = document.getElementById('emailMessage').value;
            
            if (!userEmail) {
                showToast('Please select a user', 'error');
                return;
            }
            
            if (!subject || !message) {
                showToast('Please fill in subject and message', 'error');
                return;
            }
            
            // Simulate email sending
            const mailtoLink = `mailto:${userEmail}?cc=${ADMIN_EMAIL}&subject=[Whisper+Me] ${subject}&body=${encodeURIComponent(message)}`;
            
            showToast('Opening email client...', 'info');
            
            // Open email client
            setTimeout(() => {
                window.open(mailtoLink, '_blank');
            }, 500);
            
            // Log the email (for tracking)
            db.collection('adminLogs').add({
                type: 'email',
                to: userEmail,
                subject: subject,
                sentBy: currentUser.uid,
                sentAt: firebase.firestore.FieldValue.serverTimestamp()
            });
        }
        
        function addCoinsToUser() {
            const userId = prompt('Enter user ID to add coins to:');
            if (!userId) return;
            
            const coins = prompt('How many coins to add?', '10');
            if (!coins) return;
            
            const amount = parseInt(coins);
            if (isNaN(amount) || amount <= 0) {
                showToast('Invalid coin amount', 'error');
                return;
            }
            
            if (confirm(`Add ${amount} coins to user ${userId.substring(0, 8)}...?`)) {
                db.collection('users').doc(userId).update({
                    coins: firebase.firestore.FieldValue.increment(amount),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                }).then(() => {
                    showToast(`${amount} coins added to user`, 'success');
                    loadAdminData(); // Refresh
                }).catch(error => {
                    showToast('Error: ' + error.message, 'error');
                });
            }
        }
        
        function viewUser(userId) {
            alert(`View user: ${userId}\n\nIn a full system, this would show detailed user profile.`);
            // You could implement a modal with full user details
        }
        
        function editUser(userId) {
            alert(`Edit user: ${userId}\n\nIn a full system, this would open an edit form.`);
        }
        
        function emailUser(userId, userEmail) {
            if (!userEmail) {
                showToast('User has no email on file', 'error');
                return;
            }
            
            const subject = prompt('Email subject:', 'Regarding your Whisper+Me account');
            if (!subject) return;
            
            const message = prompt('Email message:', 'Hello,\n\nWe wanted to follow up regarding your account.\n\nBest regards,\nWhisper+Me Team');
            if (!message) return;
            
            const mailtoLink = `mailto:${userEmail}?cc=${ADMIN_EMAIL}&subject=[Whisper+Me] ${subject}&body=${encodeURIComponent(message)}`;
            window.open(mailtoLink, '_blank');
        }
        
        // Initialize admin dashboard
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Admin dashboard loaded');
            
            initMobileMenu();
            
            // Check auth and admin status
            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    console.log('User logged in, checking admin status...');
                    
                    // Update UI
                    const userNav = document.getElementById('userNav');
                    if (userNav) {
                        userNav.textContent = 'Admin';
                    }
                    
                    // Setup logout button
                    const logoutBtn = document.getElementById('logoutBtn');
                    if (logoutBtn) {
                        logoutBtn.addEventListener('click', logoutUser);
                    }
                    
                    // Check admin access
                    await checkAdminAccess();
                    
                } else {
                    // Not logged in
                    showToast('Please log in to access admin panel', 'warning');
                    setTimeout(() => {
                        window.location.href = 'index.html';
                    }, 1500);
                }
            });
        });
    </script>
</body>
</html>

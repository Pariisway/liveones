<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Call | Whisper+Me</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Montserrat:wght@800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <style>
        .call-page { padding-top: 80px; min-height: 100vh; background: linear-gradient(135deg, #0a0a0a 0%, #151515 100%); }
        .call-container { max-width: 500px; margin: 0 auto; padding: 20px; }
        .call-card { background: var(--card-bg); border-radius: var(--radius-lg); padding: 30px; text-align: center; box-shadow: var(--shadow); }
        .call-avatar { width: 120px; height: 120px; border-radius: 50%; margin: 0 auto 20px; overflow: hidden; }
        .call-avatar img { width: 100%; height: 100%; object-fit: cover; }
        .call-status { font-size: 1.2rem; color: var(--text-gray); margin: 15px 0; }
        .call-timer { font-size: 3rem; font-weight: 800; color: var(--primary); margin: 20px 0; }
        .audio-status { display: flex; justify-content: center; gap: 30px; margin: 20px 0; }
        .audio-indicator { display: flex; align-items: center; gap: 8px; padding: 10px 15px; background: rgba(255,255,255,0.05); border-radius: 20px; }
        .audio-indicator.active { color: #28a745; }
        .audio-indicator.inactive { color: #dc3545; }
        .call-controls { display: flex; justify-content: center; gap: 20px; margin: 30px 0; }
        .call-btn { width: 60px; height: 60px; border-radius: 50%; border: none; cursor: pointer; font-size: 1.5rem; display: flex; align-items: center; justify-content: center; transition: all 0.3s ease; }
        .mute-btn { background: var(--warning); color: white; }
        .end-btn { background: var(--danger); color: white; }
        .call-btn:hover { transform: scale(1.1); box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        .call-ended { display: none; }
        .loading-spinner { width: 50px; height: 50px; border: 3px solid rgba(255,255,255,0.1); border-radius: 50%; border-top-color: var(--primary); animation: spin 1s ease-in-out infinite; margin: 20px auto; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .debug-info { background: rgba(0,0,0,0.3); padding: 10px; border-radius: 5px; font-size: 0.8rem; margin-top: 20px; color: #888; }
        .time-warning { color: #f56565; animation: pulse 1s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-brand"><i class="fas fa-comment-dots"></i><span>Whisper+Me</span></div>
            <button class="btn-outline" id="backBtn"><i class="fas fa-arrow-left"></i> Dashboard</button>
        </div>
    </nav>
    
    <div class="call-page">
        <div class="call-container">
            <div class="call-card" id="callCard">
                <div class="call-avatar" id="callAvatar">
                    <div class="loading-spinner"></div>
                </div>
                <h2 id="callPartner">Connecting...</h2>
                <div class="call-status" id="callStatus">Initializing call...</div>
                
                <div class="call-timer" id="timerDisplay">00:00</div>
                <div id="timeWarning" style="display: none; color: #f56565; font-size: 0.9rem; margin-bottom: 15px;">
                    <i class="fas fa-exclamation-triangle"></i> Call ends in <span id="timeLeft">60</span> seconds
                </div>
                
                <div class="audio-status">
                    <div class="audio-indicator active" id="localMicIndicator">
                        <i class="fas fa-microphone"></i>
                        <span>Your Mic: <span id="localMicText">On</span></span>
                    </div>
                    <div class="audio-indicator inactive" id="remoteMicIndicator">
                        <i class="fas fa-user"></i>
                        <span>Their Mic: <span id="remoteMicText">Off</span></span>
                    </div>
                </div>
                
                <div class="call-controls">
                    <button class="call-btn mute-btn" id="muteBtn">
                        <i class="fas fa-microphone"></i>
                    </button>
                    <button class="call-btn end-btn" id="endBtn">
                        <i class="fas fa-phone-slash"></i>
                    </button>
                </div>
                
                <p style="color: var(--text-gray); font-size: 0.9rem; margin-top: 20px;">
                    <i class="fas fa-info-circle"></i> Call uses 1 coin. 5-minute limit.
                </p>
            </div>
            
            <div class="call-card call-ended" id="endCard" style="display: none;">
                <div style="font-size: 4rem; color: var(--primary); margin-bottom: 20px;">
                    <i class="fas fa-check-circle"></i>
                </div>
                <h2>Call Ended</h2>
                <div style="margin: 30px 0; font-size: 1.2rem;" id="callSummary"></div>
                <button class="btn-primary" id="dashboardBtn" style="margin: 10px;">
                    <i class="fas fa-tachometer-alt"></i> Go to Dashboard
                </button>
                <button class="btn-outline" id="homeBtn" style="margin: 10px;">
                    <i class="fas fa-home"></i> Return Home
                </button>
            </div>
        </div>
    </div>
    
    <!-- Audio elements -->
    <audio id="remoteAudio" autoplay playsinline style="display: none;"></audio>
    <audio id="localAudio" muted autoplay playsinline style="display: none;"></audio>
    
    <!-- SCRIPTS -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <script src="https://download.agora.io/sdk/release/AgoraRTC_N.js"></script>
    
    <script>
        // GLOBAL VARIABLES
        let callTimer = null;
        let callSeconds = 0;
        let localAudioStream = null;
        let agoraClient = null;
        let isMuted = false;
        let currentCallId = null;
        let callData = null;
        let currentUser = null;
        let callDocListener = null;
        let serverTimer = null;
        
        // DOM ELEMENTS
        const elements = {
            callCard: null,
            callAvatar: null,
            callPartner: null,
            callStatus: null,
            timerDisplay: null,
            muteBtn: null,
            endBtn: null,
            endCard: null,
            callSummary: null
        };
        
        // INITIALIZATION
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Call page initialized');
            
            // Get DOM elements
            elements.callCard = document.getElementById('callCard');
            elements.callAvatar = document.getElementById('callAvatar');
            elements.callPartner = document.getElementById('callPartner');
            elements.callStatus = document.getElementById('callStatus');
            elements.timerDisplay = document.getElementById('timerDisplay');
            elements.muteBtn = document.getElementById('muteBtn');
            elements.endBtn = document.getElementById('endBtn');
            elements.endCard = document.getElementById('endCard');
            elements.callSummary = document.getElementById('callSummary');
            
            // Get call ID from URL
            const urlParams = new URLSearchParams(window.location.search);
            currentCallId = urlParams.get('callId');
            
            if (!currentCallId) {
                console.error('No call ID found in URL');
                window.location.href = 'dashboard.html';
                return;
            }
            
            console.log('üìû Call ID:', currentCallId);
            
            // Setup Firebase
            const firebaseConfig = {
                apiKey: "AIzaSyALbIJSI2C-p6IyMtj_F0ZqGyN1i79jOd4",
                authDomain: "whisper-chat-live.firebaseapp.com",
                projectId: "whisper-chat-live",
                storageBucket: "whisper-chat-live.firebasestorage.app",
                messagingSenderId: "302894848452",
                appId: "1:302894848452:web:61a7ab21a269533c426c91"
            };
            
            if (!firebase.apps.length) {
                firebase.initializeApp(firebaseConfig);
            }
            
            // Setup event listeners
            setupEventListeners();
            
            // Check auth state
            firebase.auth().onAuthStateChanged(async (user) => {
                if (!user) {
                    window.location.href = 'index.html';
                    return;
                }
                
                currentUser = user;
                await startCallProcess(user);
            });
        });
        
        function setupEventListeners() {
            document.getElementById('muteBtn').addEventListener('click', toggleMute);
            document.getElementById('endBtn').addEventListener('click', endCall);
            document.getElementById('backBtn').addEventListener('click', () => window.location.href = 'dashboard.html');
            document.getElementById('dashboardBtn').addEventListener('click', () => window.location.href = 'dashboard.html');
            document.getElementById('homeBtn').addEventListener('click', () => window.location.href = 'index.html');
        }
        
        async function startCallProcess(user) {
            try {
                console.log('üë§ Starting call for user:', user.uid);
                
                // 1. Load call data
                const callDoc = await firebase.firestore().collection('calls').doc(currentCallId).get();
                
                if (!callDoc.exists) {
                    alert('Call not found');
                    window.location.href = 'dashboard.html';
                    return;
                }
                
                callData = callDoc.data();
                console.log('üìä Call data loaded:', callData);
                
                // 2. Update UI
                updateUI(user);
                
                // 3. Setup real-time listener for call updates
                setupCallListener();
                
                // 4. Update call status if needed
                await updateCallStatus(user);
                
                // 5. Request microphone permission
                await requestMicrophone();
                
                // 6. Join voice channel
                await joinVoiceChannel();
                
            } catch (error) {
                console.error('‚ùå Error in call process:', error);
                alert('Error: ' + error.message);
                window.location.href = 'dashboard.html';
            }
        }
        
        function updateUI(user) {
            if (!callData) return;
            
            const isCaller = user.uid === callData.callerId;
            const partnerName = isCaller ? 
                (callData.whisperName || 'Anonymous') : 
                (callData.callerName || 'Anonymous');
            
            elements.callPartner.textContent = partnerName;
            elements.callAvatar.innerHTML = `
                <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=${encodeURIComponent(partnerName)}&backgroundColor=6c63ff" alt="${partnerName}">
            `;
            
            if (callData.status === 'ongoing') {
                elements.callStatus.textContent = 'Connected';
            } else if (callData.status === 'ringing') {
                elements.callStatus.textContent = isCaller ? 'Calling...' : 'Incoming call...';
            }
        }
        
        function setupCallListener() {
            // Listen for real-time updates to the call
            callDocListener = firebase.firestore().collection('calls').doc(currentCallId)
                .onSnapshot(async (doc) => {
                    if (!doc.exists) {
                        console.log('Call document no longer exists');
                        return;
                    }
                    
                    const data = doc.data();
                    callData = data;
                    
                    console.log('üì° Call update:', data.status);
                    
                    // Handle status changes
                    if (data.status === 'ongoing' && !callTimer) {
                        startLocalTimer();
                        startServerTimerSync();
                    }
                    
                    if (data.status === 'ended') {
                        showEndScreen();
                    }
                    
                    // Handle timer sync
                    if (data.timerSeconds && data.timerStarted) {
                        syncTimer(data.timerSeconds);
                    }
                    
                    // Auto-end after 5 minutes (300 seconds)
                    if (data.timerSeconds >= 300) {
                        console.log('‚è∞ Time limit reached, ending call');
                        endCall();
                    }
                }, (error) => {
                    console.error('Error listening to call:', error);
                });
        }
        
        async function updateCallStatus(user) {
            const isCaller = user.uid === callData.callerId;
            
            if (callData.status === 'ringing' && !isCaller) {
                // Whisper is accepting the call
                console.log('‚úÖ Whisper accepting call');
                
                await firebase.firestore().collection('calls').doc(currentCallId).update({
                    status: 'ongoing',
                    answeredTime: firebase.firestore.FieldValue.serverTimestamp(),
                    timerStarted: true,
                    timerSeconds: 0
                });
                
                elements.callStatus.textContent = 'Connected';
            }
            
            if (callData.status === 'ongoing' && isCaller) {
                // Caller joined, ensure timer is started
                await firebase.firestore().collection('calls').doc(currentCallId).update({
                    timerStarted: true
                });
            }
        }
        
        async function requestMicrophone() {
            console.log('üé§ Requesting microphone permission...');
            
            try {
                localAudioStream = await navigator.mediaDevices.getUserMedia({
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true
                    },
                    video: false
                });
                
                console.log('‚úÖ Microphone permission granted');
                
                // Play local audio (muted to avoid echo)
                const localAudioEl = document.getElementById('localAudio');
                if (localAudioEl) {
                    localAudioEl.srcObject = localAudioStream;
                }
                
                // Update UI
                document.getElementById('localMicIndicator').className = 'audio-indicator active';
                document.getElementById('localMicText').textContent = 'On';
                
                return true;
                
            } catch (error) {
                console.error('‚ùå Microphone error:', error);
                elements.callStatus.textContent = 'Microphone access required';
                document.getElementById('localMicIndicator').className = 'audio-indicator inactive';
                document.getElementById('localMicText').textContent = 'Off';
                
                // Still continue without microphone
                return false;
            }
        }
        
        async function joinVoiceChannel() {
            try {
                // CRITICAL: Both users MUST use the same channel name
                const channelName = callData.channelName;
                
                if (!channelName) {
                    console.error('No channel name in call data');
                    elements.callStatus.textContent = 'Error: No channel configured';
                    return;
                }
                
                console.log('üîä Joining Agora channel:', channelName);
                
                const APP_ID = "966c8e41da614722a88d4372c3d95dba";
                
                // Initialize Agora client
                agoraClient = AgoraRTC.createClient({ mode: "rtc", codec: "vp8" });
                await agoraClient.init(APP_ID);
                
                // Generate UID - using user ID for consistency
                const uid = currentUser.uid || Math.floor(Math.random() * 100000);
                
                // Join the channel
                await agoraClient.join(null, channelName, uid);
                console.log('‚úÖ Joined Agora channel:', channelName, 'as UID:', uid);
                
                // Publish local audio
                if (localAudioStream) {
                    const audioTrack = localAudioStream.getAudioTracks()[0];
                    if (audioTrack) {
                        const agoraTrack = AgoraRTC.createCustomAudioTrack({
                            mediaStreamTrack: audioTrack
                        });
                        await agoraClient.publish([agoraTrack]);
                        console.log('‚úÖ Published local audio');
                    }
                }
                
                // Listen for remote user
                agoraClient.on("user-published", async (user, mediaType) => {
                    console.log('üë§ Remote user published:', user.uid, 'Media:', mediaType);
                    
                    // Subscribe to the remote user
                    await agoraClient.subscribe(user, mediaType);
                    
                    if (mediaType === "audio") {
                        // Play remote audio
                        const remoteAudioEl = document.getElementById('remoteAudio');
                        user.audioTrack.play(remoteAudioEl);
                        
                        // Update UI
                        document.getElementById('remoteMicIndicator').className = 'audio-indicator active';
                        document.getElementById('remoteMicText').textContent = 'On';
                        elements.callStatus.textContent = 'Connected to partner!';
                        
                        // Ensure timer is started
                        if (!callTimer) {
                            startLocalTimer();
                            startServerTimerSync();
                        }
                    }
                });
                
                // Handle user leaving
                agoraClient.on("user-unpublished", () => {
                    console.log('üë§ Remote user left');
                    document.getElementById('remoteMicIndicator').className = 'audio-indicator inactive';
                    document.getElementById('remoteMicText').textContent = 'Off';
                });
                
                // Handle connection state changes
                agoraClient.on("connection-state-change", (curState, prevState, reason) => {
                    console.log('üîå Connection state:', prevState, '->', curState, 'Reason:', reason);
                });
                
            } catch (error) {
                console.error('‚ùå Agora error:', error);
                elements.callStatus.textContent = 'Voice connection failed, continuing without audio';
                // Continue without voice
            }
        }
        
        function startLocalTimer() {
            if (callTimer) clearInterval(callTimer);
            
            callTimer = setInterval(() => {
                callSeconds++;
                
                const minutes = Math.floor(callSeconds / 60);
                const seconds = callSeconds % 60;
                elements.timerDisplay.textContent = 
                    `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                
                // Show warning when 1 minute left
                if (callSeconds >= 240 && callSeconds < 300) {
                    const timeLeft = 300 - callSeconds;
                    document.getElementById('timeLeft').textContent = timeLeft;
                    document.getElementById('timeWarning').style.display = 'block';
                }
                
                // 5-minute limit reached locally
                if (callSeconds >= 300) {
                    console.log('‚è∞ Local timer reached limit');
                    endCall();
                }
                
            }, 1000);
            
            console.log('‚è±Ô∏è Local timer started');
        }
        
        function startServerTimerSync() {
            // Sync timer with server every 10 seconds
            if (serverTimer) clearInterval(serverTimer);
            
            serverTimer = setInterval(async () => {
                try {
                    await firebase.firestore().collection('calls').doc(currentCallId).update({
                        timerSeconds: callSeconds,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                } catch (error) {
                    console.error('Error syncing timer:', error);
                }
            }, 10000);
        }
        
        function syncTimer(serverSeconds) {
            // Sync local timer with server if difference is significant
            if (Math.abs(serverSeconds - callSeconds) > 5) {
                console.log('üîÑ Syncing timer from server:', serverSeconds);
                callSeconds = serverSeconds;
                
                const minutes = Math.floor(callSeconds / 60);
                const seconds = callSeconds % 60;
                elements.timerDisplay.textContent = 
                    `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }
        }
        
        function toggleMute() {
            if (!localAudioStream) {
                alert('Please allow microphone access first');
                return;
            }
            
            isMuted = !isMuted;
            
            localAudioStream.getAudioTracks().forEach(track => {
                track.enabled = !isMuted;
            });
            
            if (isMuted) {
                elements.muteBtn.innerHTML = '<i class="fas fa-microphone-slash"></i>';
                elements.muteBtn.style.background = '#6c757d';
                document.getElementById('localMicIndicator').className = 'audio-indicator inactive';
                document.getElementById('localMicText').textContent = 'Off';
            } else {
                elements.muteBtn.innerHTML = '<i class="fas fa-microphone"></i>';
                elements.muteBtn.style.background = '#ed8936';
                document.getElementById('localMicIndicator').className = 'audio-indicator active';
                document.getElementById('localMicText').textContent = 'On';
            }
        }
        
        async function endCall() {
            console.log('üìû Ending call...');
            
            // Stop timers
            if (callTimer) {
                clearInterval(callTimer);
                callTimer = null;
            }
            
            if (serverTimer) {
                clearInterval(serverTimer);
                serverTimer = null;
            }
            
            try {
                // Update Firestore - this will trigger the other user's listener
                await firebase.firestore().collection('calls').doc(currentCallId).update({
                    status: 'ended',
                    endTime: firebase.firestore.FieldValue.serverTimestamp(),
                    duration: callSeconds,
                    actualDuration: callSeconds,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // Make whisper available again
                if (callData && callData.whisperId) {
                    await firebase.firestore().collection('whispers').doc(callData.whisperId).update({
                        isAvailable: true,
                        lastOnline: firebase.firestore.FieldValue.serverTimestamp()
                    });
                }
                
                // Clean up Agora
                if (agoraClient) {
                    await agoraClient.leave();
                    agoraClient = null;
                }
                
                // Stop microphone
                if (localAudioStream) {
                    localAudioStream.getTracks().forEach(track => track.stop());
                    localAudioStream = null;
                }
                
                // Remove listener
                if (callDocListener) {
                    callDocListener();
                    callDocListener = null;
                }
                
                // Show end screen
                showEndScreen();
                
            } catch (error) {
                console.error('Error ending call:', error);
                showEndScreen();
            }
        }
        
        function showEndScreen() {
            elements.callCard.style.display = 'none';
            elements.endCard.style.display = 'block';
            
            const minutes = Math.floor(callSeconds / 60);
            const seconds = callSeconds % 60;
            
            let summary = `Duration: ${minutes}:${seconds.toString().padStart(2, '0')}`;
            
            // Show earnings for whisper
            if (currentUser && callData && currentUser.uid === callData.whisperId && callSeconds >= 30) {
                summary += `<br><span style="color: var(--success);"><i class="fas fa-dollar-sign"></i> Earned: $${(callData.earnings || 12.00).toFixed(2)}</span>`;
            }
            
            elements.callSummary.innerHTML = summary;
        }
        
        // Clean up on page unload
        window.addEventListener('beforeunload', function() {
            if (callTimer || agoraClient || localAudioStream) {
                endCall();
            }
        });
    </script>
</body>
</html>

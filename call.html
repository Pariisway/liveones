<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Whisper+Me - Active Call</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <script src="https://unpkg.com/agora-rtc-sdk-ng@4.19.2/AgoraRTC_N.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 100%);
            color: white;
            min-height: 100vh;
        }
        
        .call-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .call-header {
            text-align: center;
            padding: 30px 0;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 20px;
            margin-bottom: 30px;
            backdrop-filter: blur(10px);
        }
        
        .call-title {
            font-size: 2.5rem;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }
        
        .call-subtitle {
            color: #aaa;
            font-size: 1.2rem;
        }
        
        .call-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 30px;
        }
        
        .participants-section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 20px;
            padding: 30px;
            backdrop-filter: blur(10px);
        }
        
        .participants-title {
            font-size: 1.5rem;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .participants-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }
        
        .participant-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s ease;
        }
        
        .participant-card.active {
            background: rgba(108, 99, 255, 0.2);
            border: 2px solid #6c63ff;
        }
        
        .participant-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 15px;
            font-size: 2rem;
        }
        
        .participant-name {
            font-size: 1.2rem;
            margin-bottom: 5px;
        }
        
        .participant-status {
            font-size: 0.9rem;
            color: #aaa;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
        }
        
        .status-connected {
            background: #4CAF50;
            animation: pulse 2s infinite;
        }
        
        .status-disconnected {
            background: #f44336;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .controls-section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 20px;
            padding: 30px;
            backdrop-filter: blur(10px);
        }
        
        .controls-title {
            font-size: 1.5rem;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .controls-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }
        
        .control-btn {
            background: rgba(108, 99, 255, 0.2);
            border: none;
            border-radius: 15px;
            padding: 20px;
            color: white;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }
        
        .control-btn:hover {
            background: rgba(108, 99, 255, 0.3);
            transform: translateY(-2px);
        }
        
        .control-btn.active {
            background: #6c63ff;
        }
        
        .control-btn i {
            font-size: 1.5rem;
        }
        
        .control-btn.end-call {
            background: rgba(244, 67, 54, 0.2);
            color: #ff6b6b;
        }
        
        .control-btn.end-call:hover {
            background: rgba(244, 67, 54, 0.3);
        }
        
        .timer-section {
            text-align: center;
            margin-top: 20px;
        }
        
        .timer {
            font-size: 2rem;
            font-weight: 600;
            color: #6c63ff;
            background: rgba(108, 99, 255, 0.1);
            padding: 10px 30px;
            border-radius: 50px;
            display: inline-block;
        }
        
        .call-footer {
            margin-top: 30px;
            text-align: center;
            color: #aaa;
            font-size: 0.9rem;
        }
        
        .error-message {
            background: rgba(244, 67, 54, 0.2);
            border: 1px solid #f44336;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
        }
        
        .error-message i {
            font-size: 2rem;
            margin-bottom: 10px;
            color: #f44336;
        }
        
        .permission-prompt {
            background: rgba(255, 193, 7, 0.2);
            border: 1px solid #ffc107;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
        }
        
        .permission-prompt i {
            font-size: 2rem;
            margin-bottom: 10px;
            color: #ffc107;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
        }
        
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(108, 99, 255, 0.2);
            border-top: 4px solid #6c63ff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(108, 99, 255, 0.3);
        }
        
        .btn-outline {
            background: transparent;
            color: #6c63ff;
            border: 2px solid #6c63ff;
            padding: 10px 25px;
            border-radius: 25px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .btn-outline:hover {
            background: rgba(108, 99, 255, 0.1);
        }
        
        @media (max-width: 768px) {
            .call-container {
                padding: 10px;
            }
            
            .call-title {
                font-size: 2rem;
            }
            
            .participants-grid {
                grid-template-columns: 1fr;
            }
            
            .controls-grid {
                grid-template-columns: 1fr;
            }
            
            .control-btn {
                padding: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="call-container">
        <div class="call-header">
            <h1 class="call-title">Whisper+Me Call</h1>
            <p class="call-subtitle" id="callStatus">Connecting...</p>
        </div>
        
        <div class="call-main">
            <div id="loadingSection" class="loading">
                <div class="loading-spinner"></div>
                <p>Setting up your call...</p>
            </div>
            
            <div id="errorSection" class="error-message" style="display: none;">
                <i class="fas fa-exclamation-triangle"></i>
                <h3 id="errorTitle">Error</h3>
                <p id="errorMessage"></p>
                <button id="retryButton" class="btn-primary" style="margin-top: 15px;">
                    <i class="fas fa-redo"></i> Try Again
                </button>
            </div>
            
            <div id="permissionSection" class="permission-prompt" style="display: none;">
                <i class="fas fa-microphone-slash"></i>
                <h3>Microphone Permission Required</h3>
                <p>Please allow microphone access to join the call.</p>
                <button id="allowMicButton" class="btn-primary" style="margin-top: 15px;">
                    <i class="fas fa-microphone"></i> Allow Microphone
                </button>
            </div>
            
            <div id="callContent" style="display: none;">
                <div class="participants-section">
                    <h2 class="participants-title">
                        <i class="fas fa-users"></i> Participants
                    </h2>
                    <div id="participantsGrid" class="participants-grid">
                        <!-- Participants will be added here -->
                    </div>
                </div>
                
                <div class="controls-section">
                    <h2 class="controls-title">
                        <i class="fas fa-sliders-h"></i> Controls
                    </h2>
                    <div class="controls-grid">
                        <button id="micToggle" class="control-btn active">
                            <i class="fas fa-microphone"></i>
                            <span>Mute</span>
                        </button>
                        <button id="speakerToggle" class="control-btn active">
                            <i class="fas fa-volume-up"></i>
                            <span>Speaker</span>
                        </button>
                        <button id="endCallButton" class="control-btn end-call">
                            <i class="fas fa-phone-slash"></i>
                            <span>End Call</span>
                        </button>
                    </div>
                    
                    <div class="timer-section">
                        <div class="timer" id="callTimer">00:00</div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="call-footer">
            <p>Secure end-to-end encrypted voice call</p>
            <p>Need help? <a href="contact.html" style="color: #6c63ff; text-decoration: none;">Contact Support</a></p>
        </div>
    </div>
    
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    
    <script src="firebase-config.js"></script>
    
    <script>
        // Get call ID from URL
        const urlParams = new URLSearchParams(window.location.search);
        const callId = urlParams.get('callId');
        
        // Global variables
        let agoraClient = null;
        let localAudioTrack = null;
        let remoteUsers = {};
        let callStartTime = null;
        let timerInterval = null;
        let isMuted = false;
        let isSpeakerOn = true;
        
        console.log('üöÄ Call page initialized');
        
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üìû Call ID:', callId);
            
            if (!callId) {
                showError('No call ID provided', 'Please return to the whispers page and try again.');
                return;
            }
            
            // Initialize the call
            initCall();
        });
        
        async function initCall() {
            try {
                // Check authentication
                const user = await waitForAuth();
                if (!user) {
                    showError('Authentication required', 'Please log in to join calls.');
                    setTimeout(() => {
                        window.location.href = 'index.html';
                    }, 3000);
                    return;
                }
                
                console.log('üë§ Starting call for user:', user.uid);
                
                // Load call data from Firestore
                const callData = await loadCallData(callId);
                if (!callData) {
                    showError('Call not found', 'This call may have ended or does not exist.');
                    return;
                }
                
                // Update UI with call info
                document.getElementById('callStatus').textContent = `Call with ${callData.whisperName}`;
                
                // Request microphone permission
                await requestMicrophonePermission();
                
                // Join Agora channel
                await joinVoiceChannel(callData.channelName, user.uid);
                
                // Start call timer
                startCallTimer();
                
                // Setup UI controls
                setupControls();
                
            } catch (error) {
                console.error('‚ùå Call initialization error:', error);
                showError('Call Failed', error.message || 'Unknown error occurred');
            }
        }
        
        async function loadCallData(callId) {
            try {
                const callRef = db.collection('calls').doc(callId);
                const callDoc = await callRef.get();
                
                if (!callDoc.exists) {
                    throw new Error('Call not found');
                }
                
                const callData = callDoc.data();
                console.log('üìä Call data loaded:', callData);
                return callData;
                
            } catch (error) {
                console.error('‚ùå Error loading call data:', error);
                throw error;
            }
        }
        
        async function requestMicrophonePermission() {
            try {
                console.log('üé§ Requesting microphone permission...');
                
                // Test microphone access
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    audio: true,
                    video: false 
                });
                
                // Stop the test stream
                stream.getTracks().forEach(track => track.stop());
                
                console.log('‚úÖ Microphone permission granted');
                return true;
                
            } catch (error) {
                console.error('‚ùå Microphone permission error:', error);
                
                if (error.name === 'NotAllowedError') {
                    showPermissionPrompt();
                    throw new Error('Microphone access was denied. Please allow microphone access to join the call.');
                } else {
                    throw new Error('Could not access microphone. Please check your microphone settings.');
                }
            }
        }
        
        async function joinVoiceChannel(channelName, userId) {
            try {
                // TODO: Replace with your actual Agora App ID
                const appId = "966c8e41da614722a88d4372c3d95dba"; // Get this from agora.io
                
                console.log('üîä Joining Agora channel:', channelName);
                
                // Create Agora client
                agoraClient = AgoraRTC.createClient({
                    mode: "rtc",
                    codec: "vp8"
                });
                
                // Join the channel
                const uid = await agoraClient.join(appId, channelName, null, userId);
                console.log('‚úÖ Joined channel with UID:', uid);
                
                // Create and publish local audio track
                localAudioTrack = await AgoraRTC.createMicrophoneAudioTrack();
                await agoraClient.publish([localAudioTrack]);
                console.log('üé§ Published local audio track');
                
                // Listen for remote users
                agoraClient.on("user-published", async (user, mediaType) => {
                    await agoraClient.subscribe(user, mediaType);
                    console.log('üëÇ Subscribed to remote user:', user.uid);
                    
                    if (mediaType === "audio") {
                        user.audioTrack.play();
                        addRemoteParticipant(user);
                    }
                });
                
                agoraClient.on("user-unpublished", (user) => {
                    console.log('üëã Remote user unpublished:', user.uid);
                    removeRemoteParticipant(user.uid);
                });
                
                agoraClient.on("user-left", (user) => {
                    console.log('üö™ Remote user left:', user.uid);
                    removeRemoteParticipant(user.uid);
                });
                
                // Show call content
                document.getElementById('loadingSection').style.display = 'none';
                document.getElementById('callContent').style.display = 'block';
                
                // Add local participant
                addLocalParticipant(userId);
                
            } catch (error) {
                console.error('‚ùå Agora error:', error);
                throw error;
            }
        }
        
        function addLocalParticipant(userId) {
            const participantsGrid = document.getElementById('participantsGrid');
            
            const participantCard = document.createElement('div');
            participantCard.className = 'participant-card active';
            participantCard.id = `participant-${userId}`;
            
            participantCard.innerHTML = `
                <div class="participant-avatar">
                    <i class="fas fa-user"></i>
                </div>
                <div class="participant-name">You</div>
                <div class="participant-status">
                    <span class="status-dot status-connected"></span>
                    <span>Connected</span>
                </div>
            `;
            
            participantsGrid.appendChild(participantCard);
        }
        
        function addRemoteParticipant(user) {
            if (remoteUsers[user.uid]) return;
            
            remoteUsers[user.uid] = user;
            
            const participantsGrid = document.getElementById('participantsGrid');
            
            const participantCard = document.createElement('div');
            participantCard.className = 'participant-card';
            participantCard.id = `participant-${user.uid}`;
            
            // You might want to fetch the actual user name from your database
            participantCard.innerHTML = `
                <div class="participant-avatar">
                    <i class="fas fa-user"></i>
                </div>
                <div class="participant-name">Whisper</div>
                <div class="participant-status">
                    <span class="status-dot status-connected"></span>
                    <span>Connected</span>
                </div>
            `;
            
            participantsGrid.appendChild(participantCard);
        }
        
        function removeRemoteParticipant(userId) {
            if (remoteUsers[userId]) {
                delete remoteUsers[userId];
            }
            
            const participantCard = document.getElementById(`participant-${userId}`);
            if (participantCard) {
                participantCard.remove();
            }
        }
        
        function startCallTimer() {
            callStartTime = Date.now();
            
            timerInterval = setInterval(() => {
                const elapsed = Date.now() - callStartTime;
                const minutes = Math.floor(elapsed / 60000);
                const seconds = Math.floor((elapsed % 60000) / 1000);
                
                document.getElementById('callTimer').textContent = 
                    `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                
                // Auto-end call after 5 minutes (300000 ms)
                if (elapsed >= 300000) {
                    endCall();
                }
                
            }, 1000);
        }
        
        function setupControls() {
            // Mic toggle
            document.getElementById('micToggle').addEventListener('click', () => {
                if (localAudioTrack) {
                    if (isMuted) {
                        localAudioTrack.setMuted(false);
                        document.getElementById('micToggle').classList.add('active');
                        document.getElementById('micToggle').innerHTML = '<i class="fas fa-microphone"></i><span>Mute</span>';
                    } else {
                        localAudioTrack.setMuted(true);
                        document.getElementById('micToggle').classList.remove('active');
                        document.getElementById('micToggle').innerHTML = '<i class="fas fa-microphone-slash"></i><span>Unmute</span>';
                    }
                    isMuted = !isMuted;
                }
            });
            
            // Speaker toggle (for demonstration - in real app, you'd control audio output)
            document.getElementById('speakerToggle').addEventListener('click', () => {
                if (isSpeakerOn) {
                    // Mute all remote audio tracks
                    Object.values(remoteUsers).forEach(user => {
                        if (user.audioTrack) {
                            user.audioTrack.setVolume(0);
                        }
                    });
                    document.getElementById('speakerToggle').classList.remove('active');
                    document.getElementById('speakerToggle').innerHTML = '<i class="fas fa-volume-mute"></i><span>Speaker</span>';
                } else {
                    // Unmute all remote audio tracks
                    Object.values(remoteUsers).forEach(user => {
                        if (user.audioTrack) {
                            user.audioTrack.setVolume(100);
                        }
                    });
                    document.getElementById('speakerToggle').classList.add('active');
                    document.getElementById('speakerToggle').innerHTML = '<i class="fas fa-volume-up"></i><span>Mute</span>';
                }
                isSpeakerOn = !isSpeakerOn;
            });
            
            // End call button
            document.getElementById('endCallButton').addEventListener('click', endCall);
            
            // Retry button
            document.getElementById('retryButton').addEventListener('click', () => {
                location.reload();
            });
            
            // Allow mic button
            document.getElementById('allowMicButton').addEventListener('click', () => {
                initCall();
            });
        }
        
        async function endCall() {
            console.log('üìû Ending call...');
            
            // Update call status in Firestore
            try {
                const callRef = db.collection('calls').doc(callId);
                await callRef.update({
                    status: 'ended',
                    endedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
            } catch (error) {
                console.error('‚ùå Error updating call status:', error);
            }
            
            // Leave Agora channel
            if (agoraClient) {
                try {
                    // Unpublish and close local tracks
                    if (localAudioTrack) {
                        localAudioTrack.close();
                    }
                    
                    // Leave the channel
                    await agoraClient.leave();
                    console.log('‚úÖ Left Agora channel');
                    
                } catch (error) {
                    console.error('‚ùå Error leaving channel:', error);
                }
            }
            
            // Clear timer
            if (timerInterval) {
                clearInterval(timerInterval);
            }
            
            // Show call ended message
            document.getElementById('callContent').style.display = 'none';
            document.getElementById('loadingSection').style.display = 'block';
            document.getElementById('loadingSection').innerHTML = `
                <i class="fas fa-phone-slash" style="font-size: 3rem; color: #6c63ff; margin-bottom: 20px;"></i>
                <h3>Call Ended</h3>
                <p>Thank you for using Whisper+Me</p>
                <button onclick="window.location.href='index.html'" class="btn-primary" style="margin-top: 20px;">
                    <i class="fas fa-home"></i> Return Home
                </button>
            `;
        }
        
        function showError(title, message) {
            document.getElementById('loadingSection').style.display = 'none';
            document.getElementById('errorSection').style.display = 'block';
            document.getElementById('errorTitle').textContent = title;
            document.getElementById('errorMessage').textContent = message;
        }
        
        function showPermissionPrompt() {
            document.getElementById('loadingSection').style.display = 'none';
            document.getElementById('permissionSection').style.display = 'block';
        }
        
        // Helper function to wait for auth state
        function waitForAuth() {
            return new Promise((resolve) => {
                const unsubscribe = onAuthStateChanged((user) => {
                    unsubscribe();
                    resolve(user);
                });
            });
        }
        
        // Handle page unload
        window.addEventListener('beforeunload', () => {
            if (agoraClient && agoraClient.connectionState === 'CONNECTED') {
                endCall();
            }
        });
        
        // Handle browser back button
        window.addEventListener('popstate', () => {
            if (agoraClient && agoraClient.connectionState === 'CONNECTED') {
                endCall();
            }
        });
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Call | Whisper+Me</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="styles.css">
    
    <style>
        .call-page {
            padding-top: 80px;
            min-height: 100vh;
            background: linear-gradient(135deg, #0a0a0a 0%, #151515 100%);
        }
        
        .call-container {
            max-width: 500px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .call-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            border: 1px solid rgba(108, 99, 255, 0.2);
        }
        
        .call-avatar {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            margin: 0 auto 20px;
            overflow: hidden;
            border: 3px solid #6c63ff;
        }
        
        .call-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .call-status {
            font-size: 1.2rem;
            color: #aaa;
            margin: 15px 0;
        }
        
        .call-timer {
            font-size: 3rem;
            font-weight: 800;
            color: #6c63ff;
            margin: 20px 0;
            text-shadow: 0 0 10px rgba(108, 99, 255, 0.5);
        }
        
        .audio-status {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin: 20px 0;
        }
        
        .audio-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 15px;
            background: rgba(255,255,255,0.05);
            border-radius: 20px;
            min-width: 150px;
            justify-content: center;
        }
        
        .audio-indicator.active {
            color: #28a745;
            border: 1px solid rgba(40, 167, 69, 0.3);
        }
        
        .audio-indicator.inactive {
            color: #dc3545;
            border: 1px solid rgba(220, 53, 69, 0.3);
        }
        
        .call-controls {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 30px 0;
        }
        
        .call-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }
        
        .mute-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .end-btn {
            background: #dc3545;
            color: white;
        }
        
        .call-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        
        .call-ended {
            display: none;
        }
        
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 3px solid rgba(255,255,255,0.1);
            border-radius: 50%;
            border-top-color: #6c63ff;
            animation: spin 1s ease-in-out infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .debug-info {
            background: rgba(0,0,0,0.3);
            padding: 10px;
            border-radius: 5px;
            font-size: 0.8rem;
            margin-top: 20px;
            color: #888;
            text-align: left;
            font-family: monospace;
        }
        
        .debug-info span {
            color: #6c63ff;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-brand">
                <i class="fas fa-comment-dots"></i>
                <span>Whisper+Me</span>
            </div>
            <button class="btn-outline" onclick="window.location.href='dashboard.html'">
                <i class="fas fa-arrow-left"></i> Dashboard
            </button>
        </div>
    </nav>
    
    <!-- Main Call Page -->
    <div class="call-page">
        <div class="call-container">
            <!-- Active Call Card -->
            <div class="call-card" id="callCard">
                <div class="call-avatar" id="callAvatar">
                    <div class="loading-spinner"></div>
                </div>
                <h2 id="callPartner">Connecting...</h2>
                <div class="call-status" id="callStatus">Initializing call...</div>
                
                <div class="call-timer" id="callTimerDisplay">00:00</div>
                
                <div class="audio-status">
                    <div class="audio-indicator active" id="localMicIndicator">
                        <i class="fas fa-microphone"></i>
                        <span>Your Mic: <span id="localMicText">On</span></span>
                    </div>
                    <div class="audio-indicator inactive" id="remoteMicIndicator">
                        <i class="fas fa-user"></i>
                        <span>Their Mic: <span id="remoteMicText">Off</span></span>
                    </div>
                </div>
                
                <div class="call-controls">
                    <button class="call-btn mute-btn" id="muteBtn">
                        <i class="fas fa-microphone"></i>
                    </button>
                    <button class="call-btn end-btn" id="endBtn">
                        <i class="fas fa-phone-slash"></i>
                    </button>
                </div>
                
                <!-- Debug Info -->
                <div class="debug-info" style="display: none;" id="debugInfo">
                    Channel: <span id="channelDisplay">none</span><br>
                    Call ID: <span id="callIdDisplay">none</span><br>
                    User ID: <span id="userIdDisplay">none</span><br>
                    Status: <span id="statusDisplay">none</span>
                </div>
                
                <p style="color: #aaa; font-size: 0.9rem; margin-top: 20px;">
                    <i class="fas fa-info-circle"></i> Call uses 1 coin. 5-minute limit.
                </p>
            </div>
            
            <!-- End Call Card -->
            <div class="call-card call-ended" id="endCard" style="display: none;">
                <div style="font-size: 4rem; color: #6c63ff; margin-bottom: 20px;">
                    <i class="fas fa-check-circle"></i>
                </div>
                <h2>Call Ended</h2>
                <div style="margin: 30px 0; font-size: 1.2rem;" id="callSummary">
                    Duration: 00:00
                </div>
                <button class="btn-primary" onclick="window.location.href='dashboard.html'" style="margin: 10px;">
                    <i class="fas fa-tachometer-alt"></i> Go to Dashboard
                </button>
                <button class="btn-outline" onclick="window.location.href='index.html'" style="margin: 10px;">
                    <i class="fas fa-home"></i> Return Home
                </button>
            </div>
        </div>
    </div>
    
    <!-- Hidden Audio Elements -->
    <audio id="remoteAudio" autoplay playsinline style="display: none;"></audio>
    <audio id="localAudio" muted autoplay playsinline style="display: none;"></audio>
    
    <!-- Scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <script src="https://download.agora.io/sdk/release/AgoraRTC_N.js"></script>
    
    <script>
    // ===== SIMPLE, WORKING CALL SYSTEM =====
    // Using IIFE to avoid variable conflicts
    (function() {
        'use strict';
        
        console.log('ðŸš€ Starting call system...');
        
        // ===== GLOBAL VARIABLES (NO DUPLICATES) =====
        let callTimer = null;
        let callSeconds = 0;
        let localAudioStream = null;
        let agoraClient = null;
        let isMuted = false;
        let currentCallId = null;
        let callData = null;
        let firestoreUnsubscribe = null;
        
        // ===== DOM ELEMENTS =====
        const elements = {
            callCard: document.getElementById('callCard'),
            endCard: document.getElementById('endCard'),
            callPartner: document.getElementById('callPartner'),
            callStatus: document.getElementById('callStatus'),
            callTimerDisplay: document.getElementById('callTimerDisplay'),
            localMicIndicator: document.getElementById('localMicIndicator'),
            remoteMicIndicator: document.getElementById('remoteMicIndicator'),
            localMicText: document.getElementById('localMicText'),
            remoteMicText: document.getElementById('remoteMicText'),
            muteBtn: document.getElementById('muteBtn'),
            endBtn: document.getElementById('endBtn'),
            debugInfo: document.getElementById('debugInfo'),
            channelDisplay: document.getElementById('channelDisplay'),
            callIdDisplay: document.getElementById('callIdDisplay'),
            userIdDisplay: document.getElementById('userIdDisplay'),
            statusDisplay: document.getElementById('statusDisplay'),
            callSummary: document.getElementById('callSummary')
        };
        
        // ===== INITIALIZATION =====
        function init() {
            // Get call ID from URL
            const urlParams = new URLSearchParams(window.location.search);
            currentCallId = urlParams.get('callId');
            
            if (!currentCallId) {
                alert('No call ID found');
                window.location.href = 'dashboard.html';
                return;
            }
            
            console.log('Call ID:', currentCallId);
            
            // Setup Firebase
            const firebaseConfig = {
                apiKey: "AIzaSyALbIJSI2C-p6IyMtj_F0ZqGyN1i79jOd4",
                authDomain: "whisper-chat-live.firebaseapp.com",
                projectId: "whisper-chat-live",
                storageBucket: "whisper-chat-live.firebasestorage.app",
                messagingSenderId: "302894848452",
                appId: "1:302894848452:web:61a7ab21a269533c426c91"
            };
            
            if (!firebase.apps.length) {
                firebase.initializeApp(firebaseConfig);
            }
            
            const auth = firebase.auth();
            const db = firebase.firestore();
            
            // Setup event listeners
            setupEventListeners();
            
            // Start call process when user is authenticated
            auth.onAuthStateChanged(async (user) => {
                if (!user) {
                    window.location.href = 'index.html';
                    return;
                }
                
                console.log('ðŸ‘¤ User authenticated:', user.uid);
                
                // Update debug info
                if (elements.userIdDisplay) {
                    elements.userIdDisplay.textContent = user.uid.substring(0, 8) + '...';
                }
                if (elements.callIdDisplay) {
                    elements.callIdDisplay.textContent = currentCallId.substring(0, 8) + '...';
                }
                if (elements.debugInfo) {
                    elements.debugInfo.style.display = 'block';
                }
                
                try {
                    await startCallProcess(user, db);
                } catch (error) {
                    console.error('Error in call process:', error);
                    elements.callStatus.textContent = 'Error: ' + error.message;
                    setTimeout(() => {
                        window.location.href = 'dashboard.html';
                    }, 3000);
                }
            });
        }
        
        function setupEventListeners() {
            if (elements.muteBtn) {
                elements.muteBtn.addEventListener('click', toggleMute);
            }
            if (elements.endBtn) {
                elements.endBtn.addEventListener('click', endCall);
            }
        }
        
        async function startCallProcess(user, db) {
            try {
                console.log('Step 1: Loading call data...');
                
                // Load call data
                const callDoc = await db.collection('calls').doc(currentCallId).get();
                
                if (!callDoc.exists) {
                    throw new Error('Call not found');
                }
                
                callData = callDoc.data();
                console.log('Call data:', callData);
                
                // Update debug info
                if (elements.channelDisplay && callData.channelName) {
                    elements.channelDisplay.textContent = callData.channelName.substring(0, 15) + '...';
                }
                if (elements.statusDisplay) {
                    elements.statusDisplay.textContent = callData.status || 'unknown';
                }
                
                // Update UI
                updateUI(user);
                
                // Step 2: Request microphone permission
                console.log('Step 2: Requesting microphone...');
                await requestMicrophone();
                
                // Step 3: Setup Firestore listener
                console.log('Step 3: Setting up Firestore listener...');
                setupFirestoreListener(db);
                
                // Step 4: Join voice channel
                console.log('Step 4: Joining voice channel...');
                await joinVoiceChannel(user.uid);
                
                // Step 5: If both users are connected, update status to ongoing
                if (callData.status === 'ringing') {
                    await updateCallStatus('ongoing', db);
                }
                
            } catch (error) {
                console.error('Error in call process:', error);
                throw error;
            }
        }
        
        function updateUI(user) {
            if (!callData) return;
            
            const isCaller = user.uid === callData.callerId;
            const partnerName = isCaller ? 
                (callData.whisperName || 'Anonymous') : 
                (callData.callerName || 'Anonymous');
            
            elements.callPartner.textContent = partnerName;
            
            // Set avatar
            const avatarElement = document.getElementById('callAvatar');
            if (avatarElement) {
                avatarElement.innerHTML = `
                    <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=${encodeURIComponent(partnerName)}&backgroundColor=6c63ff" alt="${partnerName}">
                `;
            }
            
            if (callData.status === 'ongoing') {
                elements.callStatus.textContent = 'Connected';
                startTimer();
            } else if (callData.status === 'ringing') {
                elements.callStatus.textContent = isCaller ? 'Calling...' : 'Incoming call...';
            }
        }
        
        async function requestMicrophone() {
            try {
                console.log('ðŸŽ¤ Requesting microphone...');
                
                localAudioStream = await navigator.mediaDevices.getUserMedia({
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true
                    },
                    video: false
                });
                
                console.log('âœ… Microphone permission granted');
                
                // Play local audio (muted)
                const localAudioEl = document.getElementById('localAudio');
                if (localAudioEl) {
                    localAudioEl.srcObject = localAudioStream;
                }
                
            } catch (error) {
                console.error('âŒ Microphone error:', error);
                elements.callStatus.textContent = 'Microphone access required';
                elements.localMicIndicator.className = 'audio-indicator inactive';
                elements.localMicText.textContent = 'Off';
                
                // Show alert
                if (confirm('Microphone access is required for the call. Click OK to try again, or Cancel to continue without audio.')) {
                    await requestMicrophone();
                }
            }
        }
        
        function setupFirestoreListener(db) {
            // Listen for call updates
            firestoreUnsubscribe = db.collection('calls').doc(currentCallId)
                .onSnapshot((doc) => {
                    if (doc.exists) {
                        const newData = doc.data();
                        callData = newData;
                        
                        if (elements.statusDisplay) {
                            elements.statusDisplay.textContent = newData.status || 'unknown';
                        }
                        
                        // If call is ended, show end screen
                        if (newData.status === 'ended') {
                            showEndScreen();
                        }
                        
                        // If both are connected, start timer
                        if (newData.status === 'ongoing' && !callTimer) {
                            startTimer();
                        }
                    }
                });
        }
        
        async function joinVoiceChannel(userId) {
            try {
                if (!callData.channelName) {
                    console.error('âŒ No channel name in call data');
                    return;
                }
                
                console.log('ðŸ”Š Joining Agora channel:', callData.channelName);
                
                // Agora App ID
                const APP_ID = "966c8e41da614722a88d4372c3d95dba";
                
                // Initialize Agora
                agoraClient = AgoraRTC.createClient({ mode: "rtc", codec: "vp8" });
                await agoraClient.init(APP_ID);
                
                // Join channel
                await agoraClient.join(null, callData.channelName, userId);
                
                // Publish local audio
                if (localAudioStream) {
                    const audioTrack = localAudioStream.getAudioTracks()[0];
                    if (audioTrack) {
                        const agoraTrack = AgoraRTC.createCustomAudioTrack({
                            mediaStreamTrack: audioTrack
                        });
                        await agoraClient.publish([agoraTrack]);
                    }
                } else {
                    // Create default track
                    const defaultTrack = await AgoraRTC.createMicrophoneAudioTrack();
                    await agoraClient.publish([defaultTrack]);
                }
                
                console.log('âœ… Joined Agora channel');
                
                // Listen for remote users
                agoraClient.on("user-published", async (remoteUser, mediaType) => {
                    console.log('ðŸ‘¤ Remote user published:', remoteUser.uid);
                    
                    await agoraClient.subscribe(remoteUser, mediaType);
                    
                    if (mediaType === "audio") {
                        const remoteAudioEl = document.getElementById('remoteAudio');
                        remoteUser.audioTrack.play(remoteAudioEl);
                        
                        elements.remoteMicIndicator.className = 'audio-indicator active';
                        elements.remoteMicText.textContent = 'On';
                        elements.callStatus.textContent = 'Connected to partner!';
                        
                        startTimer();
                    }
                });
                
                agoraClient.on("user-unpublished", () => {
                    console.log('ðŸ‘¤ Remote user left');
                    elements.remoteMicIndicator.className = 'audio-indicator inactive';
                    elements.remoteMicText.textContent = 'Off';
                });
                
            } catch (error) {
                console.error('âŒ Agora error:', error);
                elements.callStatus.textContent = 'Voice connection issue (text only)';
            }
        }
        
        async function updateCallStatus(status, db) {
            try {
                await db.collection('calls').doc(currentCallId).update({
                    status: status,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
            } catch (error) {
                console.error('Error updating call status:', error);
            }
        }
        
        function startTimer() {
            if (callTimer) clearInterval(callTimer);
            
            callTimer = setInterval(() => {
                callSeconds++;
                
                const minutes = Math.floor(callSeconds / 60);
                const seconds = callSeconds % 60;
                elements.callTimerDisplay.textContent = 
                    `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                
                // 5-minute limit (300 seconds) - FORCE END
                if (callSeconds >= 300) {
                    console.log('â° 5-minute limit reached, ending call...');
                    endCall();
                }
                
            }, 1000);
            
            console.log('â±ï¸ Timer started');
        }
        
        function toggleMute() {
            if (!localAudioStream) {
                alert('Please allow microphone access first');
                return;
            }
            
            isMuted = !isMuted;
            
            localAudioStream.getAudioTracks().forEach(track => {
                track.enabled = !isMuted;
            });
            
            if (isMuted) {
                elements.muteBtn.innerHTML = '<i class="fas fa-microphone-slash"></i>';
                elements.muteBtn.style.background = '#6c757d';
                elements.localMicIndicator.className = 'audio-indicator inactive';
                elements.localMicText.textContent = 'Off';
            } else {
                elements.muteBtn.innerHTML = '<i class="fas fa-microphone"></i>';
                elements.muteBtn.style.background = '';
                elements.localMicIndicator.className = 'audio-indicator active';
                elements.localMicText.textContent = 'On';
            }
        }
        
        async function endCall() {
            console.log('ðŸ“ž Ending call...');
            
            // Stop timer
            if (callTimer) {
                clearInterval(callTimer);
                callTimer = null;
            }
            
            try {
                // Update Firestore
                const db = firebase.firestore();
                await db.collection('calls').doc(currentCallId).update({
                    status: 'ended',
                    endTime: firebase.firestore.FieldValue.serverTimestamp(),
                    duration: callSeconds,
                    actualDuration: callSeconds
                });
                
                // Make whisper available again
                if (callData && callData.whisperId) {
                    await db.collection('whispers').doc(callData.whisperId).update({
                        isAvailable: true,
                        lastOnline: firebase.firestore.FieldValue.serverTimestamp()
                    });
                }
                
                // Leave Agora
                if (agoraClient) {
                    await agoraClient.leave();
                    agoraClient = null;
                }
                
                // Stop microphone
                if (localAudioStream) {
                    localAudioStream.getTracks().forEach(track => track.stop());
                    localAudioStream = null;
                }
                
                // Unsubscribe from Firestore
                if (firestoreUnsubscribe) {
                    firestoreUnsubscribe();
                    firestoreUnsubscribe = null;
                }
                
                // Show end screen
                showEndScreen();
                
            } catch (error) {
                console.error('End call error:', error);
                showEndScreen();
            }
        }
        
        function showEndScreen() {
            if (elements.callCard) elements.callCard.style.display = 'none';
            if (elements.endCard) elements.endCard.style.display = 'block';
            
            const minutes = Math.floor(callSeconds / 60);
            const seconds = callSeconds % 60;
            
            let summary = `Duration: ${minutes}:${seconds.toString().padStart(2, '0')}`;
            
            if (callSeconds < 30) {
                summary += `<br><small style="color: #ed8936;">Call was too short for charges</small>`;
            }
            
            if (elements.callSummary) {
                elements.callSummary.innerHTML = summary;
            }
        }
        
        // Clean up on page close
        window.addEventListener('beforeunload', function() {
            if (callTimer || agoraClient || localAudioStream) {
                // Don't wait, just end immediately
                endCall();
            }
        });
        
        // Prevent refresh
        window.addEventListener('keydown', function(e) {
            if (e.key === 'F5' || (e.ctrlKey && e.key === 'r')) {
                if (confirm('Refreshing will end the call. Continue?')) {
                    endCall();
                } else {
                    e.preventDefault();
                }
            }
        });
        
        // Start everything
        document.addEventListener('DOMContentLoaded', init);
        
    })();
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard | Whisper+Me</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Montserrat:wght@800;900&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="styles.css">
    
    <style>
        .dashboard-page {
            padding-top: 100px;
            min-height: 100vh;
            background: linear-gradient(135deg, #0a0a0a 0%, #151515 100%);
        }
        
        .dashboard-header {
            text-align: center;
            margin-bottom: 40px;
        }
        
        .dashboard-header h1 {
            font-size: 3rem !important;
            margin-bottom: 10px;
        }
        
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 30px;
            margin-bottom: 40px;
        }
        
        .dashboard-card {
            background: var(--card-bg);
            border-radius: var(--radius-lg);
            padding: 30px;
            transition: var(--transition);
        }
        
        .dashboard-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow);
        }
        
        .card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }
        
        .card-title {
            font-size: 1.5rem !important;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .card-title i {
            color: var(--primary);
            font-size: 1.5rem !important;
        }
        
        .card-value {
            font-size: 3rem !important;
            font-weight: 800;
            margin-bottom: 15px;
            background: var(--gradient);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }
        
        /* Role Management Card */
        .role-management {
            grid-column: 1 / -1;
        }
        
        .role-switch-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: rgba(255, 255, 255, 0.05);
            padding: 25px;
            border-radius: var(--radius);
            margin-bottom: 20px;
        }
        
        .role-info {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .role-info h3 {
            font-size: 1.8rem !important;
            margin-bottom: 5px;
        }
        
        .role-info p {
            color: var(--text-gray);
            font-size: 1.1rem !important;
        }
        
        .role-toggle {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 70px;
            height: 34px;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--text-gray);
            transition: .4s;
            border-radius: 34px;
        }
        
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .toggle-slider {
            background-color: var(--primary);
        }
        
        input:checked + .toggle-slider:before {
            transform: translateX(36px);
        }
        
        .role-label {
            font-size: 1.3rem !important;
            font-weight: 600;
            min-width: 120px;
            text-align: center;
        }
        
        .role-description {
            background: rgba(108, 99, 255, 0.1);
            padding: 20px;
            border-radius: var(--radius);
            border-left: 4px solid var(--primary);
        }
        
        .role-description h4 {
            font-size: 1.3rem !important;
            margin-bottom: 10px;
            color: var(--primary);
        }
        
        .role-description ul {
            list-style: none;
            padding-left: 0;
        }
        
        .role-description li {
            padding: 8px 0;
            color: var(--text-gray);
            font-size: 1rem !important;
        }
        
        .role-description li i {
            color: var(--success);
            margin-right: 10px;
        }
        
        /* Availability Section */
        .availability-section {
            display: none;
            background: rgba(255, 255, 255, 0.05);
            padding: 25px;
            border-radius: var(--radius);
            margin-top: 20px;
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .availability-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }
        
        .availability-header h3 {
            font-size: 1.5rem !important;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .availability-status {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.1rem !important;
        }
        
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--text-gray);
        }
        
        .status-indicator.available {
            background: var(--success);
            box-shadow: 0 0 10px var(--success);
        }
        
        .availability-toggle {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }
        
        .stat-card {
            text-align: center;
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: var(--radius);
        }
        
        .stat-value {
            font-size: 2rem !important;
            font-weight: 800;
            display: block;
            margin-bottom: 5px;
        }
        
        .stat-label {
            color: var(--text-gray);
            font-size: 0.9rem !important;
        }
        
        .quick-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }
        
        .action-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 25px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: var(--radius);
            transition: var(--transition);
            text-decoration: none;
            color: white;
            text-align: center;
        }
        
        .action-btn:hover {
            background: var(--primary);
            transform: translateY(-3px);
        }
        
        .action-btn i {
            font-size: 2.5rem !important;
            margin-bottom: 15px;
        }
        
        .action-btn span {
            font-size: 1.1rem !important;
            font-weight: 600;
        }
        
        .call-history {
            margin-top: 40px;
        }
        
        .history-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: var(--radius);
            margin-bottom: 15px;
        }
        
        .history-info h4 {
            font-size: 1.2rem !important;
            margin-bottom: 5px;
        }
        
        .history-info p {
            color: var(--text-gray);
            font-size: 0.9rem !important;
        }
        
        .history-duration {
            font-weight: 600;
            color: var(--primary);
        }
        
        .empty-history {
            text-align: center;
            padding: 40px;
            color: var(--text-gray);
        }
        
        .empty-history i {
            font-size: 3rem !important;
            margin-bottom: 20px;
            color: var(--text-gray);
        }
        
        @media (max-width: 768px) {
            .role-switch-container {
                flex-direction: column;
                gap: 20px;
                text-align: center;
            }
            
            .role-toggle {
                width: 100%;
                justify-content: center;
            }
        }
        
        /* Availability Button Style */
        .availability-toggle-button {
            padding: 10px 20px;
            border-radius: 50px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .availability-toggle-button.online {
            background-color: #28a745;
            color: white;
        }
        
        .availability-toggle-button.offline {
            background-color: #6c757d;
            color: white;
        }
        
        /* Flash Notification for Calls */
        .flash-notification {
            display: none;
            position: fixed;
            top: 15px;
            right: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            z-index: 9999;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            animation: flash 1s infinite;
            font-weight: bold;
        }
        
        @keyframes flash {
            0%, 100% { opacity: 1; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
            50% { opacity: 0.8; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        }
        
        /* Call Card Styles */
        .call-card {
            border-left: 4px solid #28a745 !important;
            transition: all 0.3s ease;
        }
        
        .call-card:hover {
            background-color: rgba(255, 255, 255, 0.05);
            transform: translateX(2px);
        }
        
        .badge {
            background: var(--primary);
            color: white;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
        }
        
        /* Notification styles */
        .notification {
            display: none;
            position: fixed;
            top: 20px;
            right: 20px;
            background: #28a745;
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            z-index: 9999;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            animation: slideIn 0.3s ease;
            max-width: 350px;
        }
        
        .notification.error {
            background: #f56565;
        }
        
        .notification.warning {
            background: #ed8936;
        }
        
        .notification.info {
            background: #4299e1;
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-brand">
                <i class="fas fa-comment-dots"></i>
                <span>Whisper+Me</span>
            </div>
            
            <div class="nav-menu">
                <a href="index.html" class="nav-link">Home</a>
                <a href="index.html#whispers" class="nav-link">Whispers</a>
                <a href="index.html#how-it-works" class="nav-link">How It Works</a>
                <a href="payment.html" class="nav-link">Buy Coins</a>
                <a href="enhanced-dashboard.html" class="nav-link active">Dashboard</a>
            </div>
            
            <div class="nav-actions">
                <span id="userNav" class="nav-user">User</span>
                <button id="logoutBtn" class="btn-outline">Log Out</button>
            </div>
            
            <button class="mobile-menu-btn">
                <i class="fas fa-bars"></i>
            </button>
        </div>
    </nav>

    <div class="dashboard-page">
        <div class="container">
            <div class="dashboard-header">
                <h1>Your Dashboard</h1>
                <p style="color: var(--text-gray); font-size: 1.2rem !important;">Welcome back! Here's your activity overview.</p>
            </div>
            
            <div class="dashboard-grid">
                <!-- Coin Balance -->
                <div class="dashboard-card">
                    <div class="card-header">
                        <div class="card-title">
                            <i class="fas fa-coins"></i>
                            <span>Coin Balance</span>
                        </div>
                        <a href="payment.html" class="btn-outline btn-sm">Add Coins</a>
                    </div>
                    <div class="card-value" id="coinBalance">0</div>
                    <p style="color: var(--text-gray);">1 coin = 5 minutes of conversation</p>
                </div>
                
                <!-- Total Calls -->
                <div class="dashboard-card">
                    <div class="card-header">
                        <div class="card-title">
                            <i class="fas fa-phone-alt"></i>
                            <span>Total Calls</span>
                        </div>
                    </div>
                    <div class="card-value" id="totalCalls">0</div>
                    <p style="color: var(--text-gray);">Conversations you've had</p>
                </div>
                
                <!-- Your Rating -->
                <div class="dashboard-card">
                    <div class="card-header">
                        <div class="card-title">
                            <i class="fas fa-star"></i>
                            <span>Your Rating</span>
                        </div>
                    </div>
                    <div class="card-value" id="userRating">5.0</div>
                    <div class="stars" id="starRating" style="color: #FFD700; font-size: 1.5rem; margin-top: 10px;">
                        ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ
                    </div>
                </div>
            </div>
            
            <!-- Role Management Card -->
            <div class="dashboard-card role-management">
                <h2 style="font-size: 2rem !important; margin-bottom: 25px;">Role Management</h2>
                
                <div class="role-switch-container">
                    <div class="role-info">
                        <h3 id="roleLabel">Caller Mode</h3>
                        <p id="roleDescription">You are currently a caller. Switch to whisper mode to earn coins by taking calls.</p>
                    </div>
                    
                    <div class="role-toggle">
                        <span class="role-label">Caller</span>
                        <label class="toggle-switch">
                            <input type="checkbox" id="roleToggle">
                            <span class="toggle-slider"></span>
                        </label>
                        <span class="role-label">Whisper</span>
                    </div>
                </div>
                
                <div class="role-description" id="callerDescription">
                    <h4><i class="fas fa-phone"></i> Caller Benefits:</h4>
                    <ul>
                        <li><i class="fas fa-check"></i> Connect with amazing whispers instantly</li>
                        <li><i class="fas fa-check"></i> Pay per call - no subscriptions</li>
                        <li><i class="fas fa-check"></i> 1 Whisper Coin per call</li>
                        <li><i class="fas fa-check"></i> Safe and secure conversations</li>
                    </ul>
                </div>
                
                <div class="role-description" id="whisperDescription" style="display: none;">
                    <h4><i class="fas fa-user-check"></i> Whisper Benefits:</h4>
                    <ul>
                        <li><i class="fas fa-check"></i> Earn <strong>$12.00 per 5-minute call</strong></li>
                        <li><i class="fas fa-check"></i> Set your own availability</li>
                        <li><i class="fas fa-check"></i> Build your reputation with ratings</li>
                        <li><i class="fas fa-check"></i> Flexible schedule - work when you want</li>
                    </ul>
                </div>
                
                <!-- Availability Section (Shows only for whispers) -->
                <div class="availability-section" id="availabilitySection">
                    <div class="availability-header">
                        <div>
                            <h3><i class="fas fa-toggle-on"></i> Availability Status</h3>
                            <div class="availability-status">
                                <div class="status-indicator" id="statusIndicator"></div>
                                <span id="statusText">Currently unavailable</span>
                            </div>
                        </div>
                        
                        <div class="availability-toggle">
                            <span>Unavailable</span>
                            <label class="toggle-switch">
                                <input type="checkbox" id="availabilityToggle">
                                <span class="toggle-slider"></span>
                            </label>
                            <span>Available</span>
                        </div>
                    </div>
                    
                    <p style="color: var(--text-gray); margin-top: 15px; font-size: 1rem !important;">
                        When you're available, callers can see your profile and connect with you. You'll earn <strong>$12.00</strong> for every 5-minute call.
                    </p>
                </div>
            </div>
            
            <!-- Quick Actions -->
            <div class="dashboard-card">
                <h2 style="font-size: 1.8rem !important; margin-bottom: 20px;">Quick Actions</h2>
                <div class="quick-actions">
                    <a href="index.html#whispers" class="action-btn">
                        <i class="fas fa-search"></i>
                        <span>Find Whispers</span>
                    </a>
                    
                    <a href="payment.html" class="action-btn">
                        <i class="fas fa-shopping-cart"></i>
                        <span>Buy Coins</span>
                    </a>
                    
                    <a href="edit-profile.html" class="action-btn">
                        <i class="fas fa-user-edit"></i>
                        <span>Edit Profile</span>
                    </a>
                    
                    <a href="#" class="action-btn" id="startWhisperingBtn">
                        <i class="fas fa-broadcast-tower"></i>
                        <span>Start Whispering</span>
                    </a>
                    
                    <a href="index.html" class="action-btn">
                        <i class="fas fa-home"></i>
                        <span>Back to Home</span>
                    </a>
                </div>
            </div>
            
            <!-- Incoming Calls for Whispers -->
            <div class="dashboard-card" id="incomingCallsCard" style="display: none;">
                <div class="card-header">
                    <div class="card-title">
                        <i class="fas fa-phone-volume"></i>
                        <span>Incoming Calls</span>
                    </div>
                    <span class="badge" id="incomingCallCount">0</span>
                </div>
                
                <div id="incomingCallsList" class="call-history">
                    <div class="empty-history">
                        <i class="fas fa-phone-slash"></i>
                        <h3>No incoming calls</h3>
                        <p>When you're available, callers will see you here!</p>
                    </div>
                </div>
            </div>
            
            <!-- Recent Calls -->
            <div class="dashboard-card">
                <div class="card-header">
                    <div class="card-title">
                        <i class="fas fa-history"></i>
                        <span>Recent Calls</span>
                    </div>
                    <button class="btn-outline btn-sm" id="refreshHistoryBtn">Refresh</button>
                </div>
                
                <div class="call-history" id="callHistory">
                    <div class="empty-history">
                        <i class="fas fa-history"></i>
                        <h3>No calls yet</h3>
                        <p>Start your first conversation!</p>
                        <a href="index.html#whispers" class="btn-primary" style="margin-top: 20px;">
                            <i class="fas fa-phone-alt"></i> Find Whispers
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Flash Notification for Calls -->
    <div id="flash-notification" class="flash-notification">
        <span style="margin-right: 10px;">‚ö°</span>
        <span id="flash-count">1</span> New Call Waiting!
    </div>

    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-brand">
                    <i class="fas fa-comment-dots"></i>
                    <span>Whisper+Me</span>
                    <p style="margin-top: 15px; max-width: 300px; font-size: 1.1rem !important;">
                        Connecting people through meaningful conversations.
                    </p>
                </div>
                
                <div class="footer-links">
                    <h4>Platform</h4>
                    <a href="index.html#whispers">Find Whispers</a>
                    <a href="index.html#how-it-works">How It Works</a>
                    <a href="payment.html">Buy Coins</a>
                    <a href="become-whisper.html">Become a Whisper</a>
                </div>
                
                <div class="footer-links">
                    <h4>Support</h4>
                    <a href="faq.html">FAQ</a>
                    <a href="guidelines.html">Community Guidelines</a>
                    <a href="contact.html">Contact Us</a>
                    <a href="status.html">Service Status</a>
                </div>
            </div>
            
            <div class="footer-bottom">
                <p>&copy; 2024 Whisper+Me. All rights reserved.</p>
                <div class="footer-legal">
                    <a href="terms.html">Terms</a>
                    <a href="privacy.html">Privacy</a>
                    <a href="guidelines.html">Guidelines</a>
                </div>
            </div>
        </div>
    </footer>

    <!-- Profile Popup Modal -->
    <div id="profilePopup" class="profile-modal" style="display: none;">
        <div class="profile-modal-content">
            <span class="profile-close-btn">&times;</span>
            <div id="profilePopupContent">
                <!-- Profile content will be loaded here -->
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    
    <script src="firebase-config.js"></script>
    <script src="scripts.js"></script>
    
    <!-- Unified Role & Availability System -->
    <script>
    console.log('üîß Loading Unified Role & Availability System...');

    let roleAvailabilityInitialized = false;
    let currentUserData = null;
    let callListener = null;

    document.addEventListener('DOMContentLoaded', function() {
        // Wait for Firebase to be ready
        const checkFirebase = setInterval(() => {
            if (typeof firebase !== 'undefined' && firebase.auth) {
                clearInterval(checkFirebase);
                
                firebase.auth().onAuthStateChanged(async function(user) {
                    if (user) {
                        console.log('üë§ User authenticated for availability system:', user.email);
                        await initializeRoleAvailabilitySystem(user);
                    }
                });
            }
        }, 500);
    });

    async function initializeRoleAvailabilitySystem(user) {
        try {
            // Get user data
            const userDoc = await firebase.firestore().collection('users').doc(user.uid).get();
            const whisperDoc = await firebase.firestore().collection('whispers').doc(user.uid).get();
            
            currentUserData = {
                uid: user.uid,
                email: user.email,
                displayName: user.displayName || ''
            };
            
            // Determine current role
            let currentRole = 'caller';
            if (userDoc.exists) {
                currentRole = userDoc.data().role || 'caller';
            }
            
            // Determine current availability
            let isAvailable = false;
            if (whisperDoc.exists && whisperDoc.data().isAvailable === true) {
                isAvailable = true;
            }
            
            console.log('üìä Initial state - Role:', currentRole, 'Available:', isAvailable);
            
            // Update UI
            updateRoleToggleUI(currentRole);
            updateAvailabilityUI(currentRole, isAvailable);
            
            // Setup event listeners
            setupRoleToggleListener(user.uid, currentRole);
            setupAvailabilityToggleListener(user.uid, currentRole);
            
            // Setup other dashboard listeners
            setupDashboardListeners(user.uid);
            
            // Load initial data
            loadDashboardData(user.uid);
            loadCallHistory(user.uid);
            
            // If user is whisper, monitor incoming calls
            if (currentRole === 'whisper') {
                monitorIncomingCalls(user.uid);
            }
            
            roleAvailabilityInitialized = true;
            
        } catch (error) {
            console.error('‚ùå Error initializing role/availability:', error);
        }
    }

    async function loadDashboardData(userId) {
        try {
            const userDoc = await firebase.firestore().collection('users').doc(userId).get();
            if (userDoc.exists) {
                const data = userDoc.data();
                
                // Update coin balance
                const coinBalance = document.getElementById('coinBalance');
                if (coinBalance) {
                    coinBalance.textContent = data.coins || 0;
                }
                
                // Update total calls
                const totalCalls = document.getElementById('totalCalls');
                if (totalCalls) {
                    // Count user's calls
                    const callsSnapshot = await firebase.firestore()
                        .collection('calls')
                        .where('participants', 'array-contains', userId)
                        .get();
                    totalCalls.textContent = callsSnapshot.size;
                }
                
                // Update rating
                const userRating = document.getElementById('userRating');
                const starRating = document.getElementById('starRating');
                if (userRating && starRating) {
                    const rating = data.rating || 5.0;
                    userRating.textContent = rating.toFixed(1);
                    
                    // Create star display
                    const fullStars = Math.floor(rating);
                    const hasHalfStar = rating % 1 >= 0.5;
                    let stars = '‚òÖ'.repeat(fullStars);
                    if (hasHalfStar) stars += '‚òÜ';
                    stars += '‚òÜ'.repeat(5 - fullStars - (hasHalfStar ? 1 : 0));
                    starRating.innerHTML = stars;
                }
            }
        } catch (error) {
            console.error('‚ùå Error loading dashboard data:', error);
        }
    }

    function updateRoleToggleUI(role) {
        const roleToggle = document.getElementById('roleToggle');
        const roleLabel = document.getElementById('roleLabel');
        const roleDescription = document.getElementById('roleDescription');
        const callerDescription = document.getElementById('callerDescription');
        const whisperDescription = document.getElementById('whisperDescription');
        const availabilitySection = document.getElementById('availabilitySection');
        const startWhisperingBtn = document.getElementById('startWhisperingBtn');
        const incomingCallsCard = document.getElementById('incomingCallsCard');
        
        if (roleToggle) {
            roleToggle.checked = (role === 'whisper');
        }
        
        if (role === 'whisper') {
            if (roleLabel) roleLabel.textContent = 'Whisper Mode';
            if (roleDescription) roleDescription.textContent = 'You are currently a whisper. Switch to caller mode to connect with other whispers.';
            if (callerDescription) callerDescription.style.display = 'none';
            if (whisperDescription) whisperDescription.style.display = 'block';
            if (availabilitySection) availabilitySection.style.display = 'block';
            if (incomingCallsCard) incomingCallsCard.style.display = 'block';
            
            if (startWhisperingBtn) {
                startWhisperingBtn.innerHTML = '<i class="fas fa-phone"></i> <span>Take a Call</span>';
                startWhisperingBtn.href = '#';
                startWhisperingBtn.onclick = function(e) {
                    e.preventDefault();
                    // Already a whisper, go to home to see available whispers
                    window.location.href = 'index.html#whispers';
                };
            }
        } else {
            if (roleLabel) roleLabel.textContent = 'Caller Mode';
            if (roleDescription) roleDescription.textContent = 'You are currently a caller. Switch to whisper mode to earn coins by taking calls.';
            if (callerDescription) callerDescription.style.display = 'block';
            if (whisperDescription) whisperDescription.style.display = 'none';
            if (availabilitySection) availabilitySection.style.display = 'none';
            if (incomingCallsCard) incomingCallsCard.style.display = 'none';
            
            if (startWhisperingBtn) {
                startWhisperingBtn.innerHTML = '<i class="fas fa-broadcast-tower"></i> <span>Start Whispering</span>';
                startWhisperingBtn.href = '#';
                startWhisperingBtn.onclick = function(e) {
                    e.preventDefault();
                    // Switch to whisper mode
                    document.getElementById('roleToggle').checked = true;
                    document.getElementById('roleToggle').dispatchEvent(new Event('change'));
                };
            }
        }
    }

    function updateAvailabilityUI(role, isAvailable) {
        const availabilityToggle = document.getElementById('availabilityToggle');
        const statusIndicator = document.getElementById('statusIndicator');
        const statusText = document.getElementById('statusText');
        
        if (!availabilityToggle || !statusIndicator || !statusText) return;
        
        if (role === 'whisper') {
            // Enable for whispers
            availabilityToggle.disabled = false;
            availabilityToggle.checked = isAvailable;
            
            if (isAvailable) {
                statusIndicator.className = 'status-indicator available';
                statusText.textContent = 'Currently available for calls';
            } else {
                statusIndicator.className = 'status-indicator';
                statusText.textContent = 'Currently unavailable';
            }
        } else {
            // Caller mode - disable availability
            availabilityToggle.disabled = true;
            availabilityToggle.checked = false;
            statusIndicator.className = 'status-indicator';
            statusText.textContent = 'Available only in whisper mode';
        }
    }

    function setupRoleToggleListener(userId, currentRole) {
        const roleToggle = document.getElementById('roleToggle');
        if (!roleToggle) return;
        
        roleToggle.addEventListener('change', async function() {
            const newRole = this.checked ? 'whisper' : 'caller';
            console.log('üîÑ Switching role to:', newRole);
            
            try {
                // Update user document
                await firebase.firestore().collection('users').doc(userId).set({
                    role: newRole,
                    email: currentUserData.email,
                    displayName: currentUserData.displayName,
                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });
                
                // Handle whisper document
                if (newRole === 'whisper') {
                    // Create whisper document with default availability: true
                    await firebase.firestore().collection('whispers').doc(userId).set({
                        uid: userId,
                        email: currentUserData.email,
                        displayName: currentUserData.displayName,
                        isAvailable: true,
                        earnings: 0,
                        totalCalls: 0,
                        rating: 5.0,
                        lastOnline: firebase.firestore.FieldValue.serverTimestamp(),
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    }, { merge: true });
                    
                    // Start monitoring calls
                    monitorIncomingCalls(userId);
                    
                    // Show notification
                    showToast('üéâ You are now a Whisper! You are online and visible to callers.', 'success');
                } else {
                    // Remove from whispers collection
                    await firebase.firestore().collection('whispers').doc(userId).delete()
                        .catch(() => console.log('‚ö†Ô∏è No whisper document to delete'));
                    
                    // Stop monitoring calls
                    if (callListener) {
                        callListener();
                        callListener = null;
                    }
                    
                    // Show notification
                    showToast('üîà You are now a Caller', 'info');
                }
                
                // Update UI
                updateRoleToggleUI(newRole);
                updateAvailabilityUI(newRole, newRole === 'whisper');
                
                // Reload dashboard data
                loadDashboardData(userId);
                
            } catch (error) {
                console.error('‚ùå Error switching role:', error);
                showToast('‚ö†Ô∏è Error switching role', 'warning');
                // Revert toggle
                roleToggle.checked = !roleToggle.checked;
            }
        });
    }

    function setupAvailabilityToggleListener(userId, currentRole) {
        const availabilityToggle = document.getElementById('availabilityToggle');
        if (!availabilityToggle) return;
        
        availabilityToggle.addEventListener('change', async function() {
            if (currentRole !== 'whisper') {
                showToast('‚ö†Ô∏è Switch to Whisper role first', 'warning');
                this.checked = false;
                return;
            }
            
            const isAvailable = this.checked;
            console.log('üîÑ Setting availability to:', isAvailable);
            
            try {
                // Update whisper document
                await firebase.firestore().collection('whispers').doc(userId).update({
                    isAvailable: isAvailable,
                    lastOnline: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // Also update user document
                await firebase.firestore().collection('users').doc(userId).update({
                    isAvailable: isAvailable,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // Update UI
                updateAvailabilityUI('whisper', isAvailable);
                
                if (isAvailable) {
                    showToast('‚úÖ You are now Online - visible to callers', 'success');
                    // Start monitoring calls
                    monitorIncomingCalls(userId);
                } else {
                    showToast('‚õî You are now Offline - hidden from callers', 'info');
                    // Stop monitoring calls
                    if (callListener) {
                        callListener();
                        callListener = null;
                    }
                }
                
            } catch (error) {
                console.error('‚ùå Error setting availability:', error);
                showToast('‚ö†Ô∏è Error updating availability', 'warning');
                // Revert toggle
                availabilityToggle.checked = !availabilityToggle.checked;
            }
        });
    }

    function monitorIncomingCalls(userId) {
        // Clean up previous listener if exists
        if (callListener) {
            callListener();
        }
        
        console.log('üëÇ Setting up call listener for user:', userId);
        
        // Listen for incoming calls where user is the whisper
        callListener = firebase.firestore()
            .collection('calls')
            .where('whisperId', '==', userId)
            .where('status', '==', 'ringing')
            .onSnapshot(function(snapshot) {
                updateIncomingCallsUI(snapshot);
                
                snapshot.docChanges().forEach((change) => {
                    if (change.type === 'added') {
                        const call = change.doc.data();
                        console.log('üìû New incoming call:', call);
                        
                        // Show browser notification
                        if ("Notification" in window && Notification.permission === "granted") {
                            new Notification('üìû Incoming Call!', {
                                body: 'Click to join the chat',
                                icon: 'https://cdn-icons-png.flaticon.com/512/646/646094.png',
                                requireInteraction: true
                            });
                        }
                        
                        // Show flash notification
                        const flash = document.getElementById('flash-notification');
                        const flashCount = document.getElementById('flash-count');
                        if (flash && flashCount) {
                            flashCount.textContent = snapshot.size;
                            flash.style.display = 'block';
                            
                            // Auto-hide after 10 seconds
                            setTimeout(() => {
                                flash.style.display = 'none';
                            }, 10000);
                        }
                        
                        // Show toast notification
                        showToast('üìû Incoming Call! Click "Accept" to start.', 'info');
                    }
                });
            }, function(error) {
                console.error('‚ùå Error listening for calls:', error);
            });
    }

    function updateIncomingCallsUI(snapshot) {
        const incomingCallsCard = document.getElementById('incomingCallsCard');
        const incomingCallsList = document.getElementById('incomingCallsList');
        const incomingCallCount = document.getElementById('incomingCallCount');
        const flash = document.getElementById('flash-notification');
        
        if (!incomingCallsCard || !incomingCallsList) return;
        
        // Remove existing call cards
        const cards = incomingCallsList.querySelectorAll('.call-card');
        cards.forEach(card => card.remove());
        
        if (snapshot.empty) {
            incomingCallsCard.style.display = 'none';
            incomingCallsList.innerHTML = `
                <div class="empty-history">
                    <i class="fas fa-phone-slash"></i>
                    <h3>No incoming calls</h3>
                    <p>When you're available, callers will see you here!</p>
                </div>
            `;
            
            if (flash) flash.style.display = 'none';
            return;
        }
        
        incomingCallsCard.style.display = 'block';
        if (incomingCallCount) incomingCallCount.textContent = snapshot.size;
        
        // Add each call
        snapshot.forEach(function(doc) {
            const call = doc.data();
            const card = createCallCard(doc.id, call);
            incomingCallsList.appendChild(card);
        });
    }

    function createCallCard(callId, callData) {
        const card = document.createElement('div');
        card.className = 'history-item call-card';
        
        const startTime = callData.startTime ? callData.startTime.toDate() : new Date();
        const callerName = callData.callerName || 'Anonymous';
        
        card.innerHTML = `
            <div class="history-info">
                <h4>${callerName}</h4>
                <p>${formatRelativeTime(startTime)}</p>
                <p style="color: var(--primary); font-size: 0.8rem; margin-top: 5px;">
                    <i class="fas fa-coins"></i> Earn: $12.00
                </p>
            </div>
            <div style="display: flex; gap: 10px;">
                <button onclick="acceptIncomingCall('${callId}')" class="btn-primary btn-sm" style="padding: 8px 15px; font-size: 0.9rem;">
                    <i class="fas fa-phone"></i> Accept
                </button>
                <button onclick="declineIncomingCall('${callId}')" class="btn-outline btn-sm" style="padding: 8px 15px; font-size: 0.9rem;">
                    <i class="fas fa-times"></i> Decline
                </button>
            </div>
        `;
        
        return card;
    }

    async function acceptIncomingCall(callId) {
        try {
            const user = firebase.auth().currentUser;
            if (!user) return;
            
            console.log('‚úÖ Accepting call:', callId);
            
            // Update call status to ongoing
            await firebase.firestore().collection('calls').doc(callId).update({
                status: 'ongoing',
                answeredTime: firebase.firestore.FieldValue.serverTimestamp(),
                timerStarted: true,
                timerSeconds: 0
            });
            
            // Hide flash notification
            const flash = document.getElementById('flash-notification');
            if (flash) flash.style.display = 'none';
            
            // Redirect to call page
            window.location.href = `call.html?callId=${callId}`;
            
        } catch (error) {
            console.error('‚ùå Error accepting call:', error);
            showToast('‚ö†Ô∏è Error accepting call', 'warning');
        }
    }

    async function declineIncomingCall(callId) {
        try {
            console.log('‚ùå Declining call:', callId);
            
            await firebase.firestore().collection('calls').doc(callId).update({
                status: 'declined',
                endTime: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            // Refund coin to caller
            const callDoc = await firebase.firestore().collection('calls').doc(callId).get();
            const callData = callDoc.data();
            
            if (callData.callerId) {
                await firebase.firestore().collection('users').doc(callData.callerId).update({
                    coins: firebase.firestore.FieldValue.increment(1)
                });
            }
            
            // Make whisper available again
            await firebase.firestore().collection('whispers').doc(callData.whisperId).update({
                isAvailable: true,
                lastOnline: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            showToast('Call declined - caller refunded 1 coin', 'info');
            
        } catch (error) {
            console.error('‚ùå Error declining call:', error);
        }
    }

    function setupDashboardListeners(userId) {
        // Start Whispering button is handled in updateRoleToggleUI
        
        // Refresh history button
        const refreshHistoryBtn = document.getElementById('refreshHistoryBtn');
        if (refreshHistoryBtn) {
            refreshHistoryBtn.addEventListener('click', function() {
                loadCallHistory(userId);
            });
        }
    }

    async function loadCallHistory(userId) {
        const historyContainer = document.getElementById('callHistory');
        if (!historyContainer) return;
        
        try {
            // Get call history from Firestore
            const callsRef = firebase.firestore().collection('calls')
                .where('participants', 'array-contains', userId)
                .orderBy('startTime', 'desc')
                .limit(10);
            
            const snapshot = await callsRef.get();
            
            if (snapshot.empty) {
                historyContainer.innerHTML = `
                    <div class="empty-history">
                        <i class="fas fa-history"></i>
                        <h3>No calls yet</h3>
                        <p>Start your first conversation!</p>
                        <a href="index.html#whispers" class="btn-primary" style="margin-top: 20px;">
                            <i class="fas fa-phone-alt"></i> Find Whispers
                        </a>
                    </div>
                `;
                return;
            }
            
            let html = '';
            snapshot.forEach(doc => {
                const call = doc.data();
                const startTime = call.startTime ? call.startTime.toDate() : new Date();
                const duration = call.duration || 0;
                const status = call.status || 'completed';
                
                // Determine if user was caller or whisper
                const userRole = call.callerId === userId ? 'Caller' : 'Whisper';
                const earnings = userRole === 'Whisper' ? call.earnings || 12.00 : 0;
                
                html += `
                    <div class="history-item">
                        <div class="history-info">
                            <h4>${formatDate(startTime)}</h4>
                            <p>${status} ‚Ä¢ ${userRole} ‚Ä¢ ${formatDuration(duration)}</p>
                            ${earnings > 0 ? `<p style="color: var(--success); font-size: 0.9rem; margin-top: 5px;">
                                <i class="fas fa-dollar-sign"></i> Earned: $${earnings.toFixed(2)}
                            </p>` : ''}
                        </div>
                        <div class="history-duration">
                            ${formatDuration(duration)}
                        </div>
                    </div>
                `;
            });
            
            historyContainer.innerHTML = html;
            
        } catch (error) {
            console.error('‚ùå Error loading call history:', error);
            historyContainer.innerHTML = `
                <div class="empty-history">
                    <i class="fas fa-exclamation-triangle"></i>
                    <h3>Error loading history</h3>
                    <p>Please try again later</p>
                </div>
            `;
        }
    }

    function formatDate(date) {
        return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    }

    function formatDuration(seconds) {
        if (!seconds) return '0m';
        const minutes = Math.floor(seconds / 60);
        const remainingSeconds = seconds % 60;
        return `${minutes}m ${remainingSeconds}s`;
    }

    function formatRelativeTime(date) {
        const now = new Date();
        const diffInSeconds = Math.floor((now - date) / 1000);
        
        if (diffInSeconds < 60) return `${diffInSeconds} seconds ago`;
        if (diffInSeconds < 3600) return `${Math.floor(diffInSeconds / 60)} minutes ago`;
        if (diffInSeconds < 86400) return `${Math.floor(diffInSeconds / 3600)} hours ago`;
        return date.toLocaleDateString();
    }

    // Show toast function (compatible with firebase-config.js)
    function showToast(message, type = 'info') {
        console.log(`Toast [${type}]:`, message);
        
        // Use existing toast function if available
        if (typeof window.showToast === 'function') {
            window.showToast(message, type);
            return;
        }
        
        // Fallback implementation
        const toast = document.createElement('div');
        toast.className = `toast toast-${type}`;
        toast.innerHTML = `
            <div>${message}</div>
            <button onclick="this.parentElement.remove()">&times;</button>
        `;
        
        document.body.appendChild(toast);
        
        setTimeout(() => {
            if (toast.parentNode) {
                toast.remove();
            }
        }, 5000);
    }

    // Make functions available globally
    window.acceptIncomingCall = acceptIncomingCall;
    window.declineIncomingCall = declineIncomingCall;
    window.showToast = showToast;

    console.log('‚úÖ Unified Role & Availability System ready!');
    </script>
</body>
</html>
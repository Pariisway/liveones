<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard | Whisper+Me</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Montserrat:wght@800;900&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="styles.css">
    
    <style>
        .dashboard-page {
            padding-top: 100px;
            min-height: 100vh;
            background: linear-gradient(135deg, #0a0a0a 0%, #151515 100%);
        }
        
        .dashboard-header {
            text-align: center;
            margin-bottom: 40px;
        }
        
        .dashboard-header h1 {
            font-size: 3rem !important;
            margin-bottom: 10px;
        }
        
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 30px;
            margin-bottom: 40px;
        }
        
        .dashboard-card {
            background: var(--card-bg);
            border-radius: var(--radius-lg);
            padding: 30px;
            transition: var(--transition);
        }
        
        .dashboard-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow);
        }
        
        .card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }
        
        .card-title {
            font-size: 1.5rem !important;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .card-title i {
            color: var(--primary);
            font-size: 1.5rem !important;
        }
        
        .card-value {
            font-size: 3rem !important;
            font-weight: 800;
            margin-bottom: 15px;
            background: var(--gradient);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }
        
        /* Role Management Card */
        .role-management {
            grid-column: 1 / -1;
        }
        
        .role-switch-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: rgba(255, 255, 255, 0.05);
            padding: 25px;
            border-radius: var(--radius);
            margin-bottom: 20px;
        }
        
        .role-info {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .role-info h3 {
            font-size: 1.8rem !important;
            margin-bottom: 5px;
        }
        
        .role-info p {
            color: var(--text-gray);
            font-size: 1.1rem !important;
        }
        
        .role-toggle {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 70px;
            height: 34px;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--text-gray);
            transition: .4s;
            border-radius: 34px;
        }
        
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .toggle-slider {
            background-color: var(--primary);
        }
        
        input:checked + .toggle-slider:before {
            transform: translateX(36px);
        }
        
        .role-label {
            font-size: 1.3rem !important;
            font-weight: 600;
            min-width: 120px;
            text-align: center;
        }
        
        .role-description {
            background: rgba(108, 99, 255, 0.1);
            padding: 20px;
            border-radius: var(--radius);
            border-left: 4px solid var(--primary);
        }
        
        .role-description h4 {
            font-size: 1.3rem !important;
            margin-bottom: 10px;
            color: var(--primary);
        }
        
        .role-description ul {
            list-style: none;
            padding-left: 0;
        }
        
        .role-description li {
            padding: 8px 0;
            color: var(--text-gray);
            font-size: 1rem !important;
        }
        
        .role-description li i {
            color: var(--success);
            margin-right: 10px;
        }
        
        /* Availability Section */
        .availability-section {
            display: none;
            background: rgba(255, 255, 255, 0.05);
            padding: 25px;
            border-radius: var(--radius);
            margin-top: 20px;
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .availability-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }
        
        .availability-header h3 {
            font-size: 1.5rem !important;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .availability-status {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.1rem !important;
        }
        
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--text-gray);
        }
        
        .status-indicator.available {
            background: var(--success);
            box-shadow: 0 0 10px var(--success);
        }
        
        .availability-toggle {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }
        
        .stat-card {
            text-align: center;
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: var(--radius);
        }
        
        .stat-value {
            font-size: 2rem !important;
            font-weight: 800;
            display: block;
            margin-bottom: 5px;
        }
        
        .stat-label {
            color: var(--text-gray);
            font-size: 0.9rem !important;
        }
        
        .quick-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }
        
        .action-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 25px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: var(--radius);
            transition: var(--transition);
            text-decoration: none;
            color: white;
            text-align: center;
        }
        
        .action-btn:hover {
            background: var(--primary);
            transform: translateY(-3px);
        }
        
        .action-btn i {
            font-size: 2.5rem !important;
            margin-bottom: 15px;
        }
        
        .action-btn span {
            font-size: 1.1rem !important;
            font-weight: 600;
        }
        
        .call-history {
            margin-top: 40px;
        }
        
        .history-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: var(--radius);
            margin-bottom: 15px;
        }
        
        .history-info h4 {
            font-size: 1.2rem !important;
            margin-bottom: 5px;
        }
        
        .history-info p {
            color: var(--text-gray);
            font-size: 0.9rem !important;
        }
        
        .history-duration {
            font-weight: 600;
            color: var(--primary);
        }
        
        .empty-history {
            text-align: center;
            padding: 40px;
            color: var(--text-gray);
        }
        
        .empty-history i {
            font-size: 3rem !important;
            margin-bottom: 20px;
            color: var(--text-gray);
        }
        
        @media (max-width: 768px) {
            .role-switch-container {
                flex-direction: column;
                gap: 20px;
                text-align: center;
            }
            
            .role-toggle {
                width: 100%;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-brand">
                <i class="fas fa-comment-dots"></i>
                <span>Whisper+Me</span>
            </div>
            
            <div class="nav-menu">
                <a href="index.html" class="nav-link">Home</a>
                <a href="index.html#whispers" class="nav-link">Whispers</a>
                <a href="index.html#how-it-works" class="nav-link">How It Works</a>
                <a href="payment.html" class="nav-link">Buy Coins</a>
                <a href="enhanced-dashboard.html" class="nav-link active">Dashboard</a>
            </div>
            
            <div class="nav-actions">
                <span id="userNav" class="nav-user">User</span>
                <button id="logoutBtn" class="btn-outline">Log Out</button>
            </div>
            
            <button class="mobile-menu-btn">
                <i class="fas fa-bars"></i>
            </button>
        </div>
    </nav>

    <div class="dashboard-page">
        <div class="container">
            <div class="dashboard-header">
                <h1>Your Dashboard</h1>
                <p style="color: var(--text-gray); font-size: 1.2rem !important;">Welcome back! Here's your activity overview.</p>
            </div>
            
            <div class="dashboard-grid">
                <!-- Coin Balance -->
                <div class="dashboard-card">
                    <div class="card-header">
                        <div class="card-title">
                            <i class="fas fa-coins"></i>
                            <span>Coin Balance</span>
                        </div>
                        <a href="payment.html" class="btn-outline btn-sm">Add Coins</a>
                    </div>
                    <div class="card-value" id="coinBalance">0</div>
                    <p style="color: var(--text-gray);">1 coin = 5 minutes of conversation</p>
                </div>
                
                <!-- Total Calls -->
                <div class="dashboard-card">
                    <div class="card-header">
                        <div class="card-title">
                            <i class="fas fa-phone-alt"></i>
                            <span>Total Calls</span>
                        </div>
                    </div>
                    <div class="card-value" id="totalCalls">0</div>
                    <p style="color: var(--text-gray);">Conversations you've had</p>
                </div>
                
                <!-- Your Rating -->
                <div class="dashboard-card">
                    <div class="card-header">
                        <div class="card-title">
                            <i class="fas fa-star"></i>
                            <span>Your Rating</span>
                        </div>
                    </div>
                    <div class="card-value" id="userRating">5.0</div>
                    <div class="stars" id="starRating" style="color: #FFD700; font-size: 1.5rem; margin-top: 10px;">
                        â˜…â˜…â˜…â˜…â˜…
                    </div>
                </div>
            </div>
            
            <!-- Role Management Card -->
            <div class="dashboard-card role-management">
                <h2 style="font-size: 2rem !important; margin-bottom: 25px;">Role Management</h2>
                
                <div class="role-switch-container">
                    <div class="role-info">
                        <h3 id="roleLabel">Caller Mode</h3>
                        <p id="roleDescription">You are currently a caller. Switch to whisper mode to earn coins by taking calls.</p>
                    </div>
                    
                    <div class="role-toggle">
                        <span class="role-label">Caller</span>
                        <label class="toggle-switch">
                            <input type="checkbox" id="roleToggle">
                            <span class="toggle-slider"></span>
                        </label>
                        <span class="role-label">Whisper</span>
                    </div>
                </div>
                
                <div class="role-description" id="callerDescription">
                    <h4><i class="fas fa-phone"></i> Caller Benefits:</h4>
                    <ul>
                        <li><i class="fas fa-check"></i> Connect with amazing whispers instantly</li>
                        <li><i class="fas fa-check"></i> Pay per call - no subscriptions</li>
                        <li><i class="fas fa-check"></i> 1 Whisper Coin per call</li>
                        <li><i class="fas fa-check"></i> Safe and secure conversations</li>
                    </ul>
                </div>
                
                <div class="role-description" id="whisperDescription" style="display: none;">
                    <h4><i class="fas fa-user-check"></i> Whisper Benefits:</h4>
                    <ul>
                        <li><i class="fas fa-check"></i> Earn $12.00 per 5-minute call</li>
                        <li><i class="fas fa-check"></i> Set your own availability</li>
                        <li><i class="fas fa-check"></i> Build your reputation with ratings</li>
                        <li><i class="fas fa-check"></i> Flexible schedule - work when you want</li>
                    </ul>
                </div>
                
                <!-- Availability Section (Shows only for whispers) -->
                <div class="availability-section" id="availabilitySection">
                    <div class="availability-header">
                        <div>
                            <h3><i class="fas fa-toggle-on"></i> Availability Status</h3>
                            <div class="availability-status">
                                <div class="status-indicator" id="statusIndicator"></div>
                                <span id="statusText">Currently unavailable</span>
                            </div>
                        </div>
                        
                        <div class="availability-toggle">
                            <span>Unavailable</span>
                            <label class="toggle-switch">
                                <input type="checkbox" id="availabilityToggle">
                                <span class="toggle-slider"></span>
                            </label>
                            <span>Available</span>
                        </div>
                    </div>
                    
                    <p style="color: var(--text-gray); margin-top: 15px; font-size: 1rem !important;">
                        When you're available, callers can see your profile and connect with you. You'll earn $0.70 for every 5-minute call.
                    </p>
                </div>
            </div>
            
            <!-- Quick Actions -->
            <div class="dashboard-card">
                <h2 style="font-size: 1.8rem !important; margin-bottom: 20px;">Quick Actions</h2>
                <div class="quick-actions">
                    <a href="index.html#whispers" class="action-btn">
                        <i class="fas fa-search"></i>
                        <span>Find Whispers</span>
                    </a>
                    
                    <a href="payment.html" class="action-btn">
                        <i class="fas fa-shopping-cart"></i>
                        <span>Buy Coins</span>
                    </a>
                    
                    <!-- ADDED: Edit Profile Button -->
                    <a href="edit-profile.html" class="action-btn">
                        <i class="fas fa-user-edit"></i>
                        <span>Edit Profile</span>
                    </a>
                    
                    <a href="#" class="action-btn" onclick="startAsWhisper()" id="startWhisperingBtn">
                        <i class="fas fa-broadcast-tower"></i>
                        <span>Start Whispering</span>
                    </a>
                    
                    <a href="#" class="action-btn" onclick="window.location.href='index.html'">
                        <i class="fas fa-home"></i>
                        <span>Back to Home</span>
                    </a>
                </div>
            </div>
            
            <!-- Recent Calls -->
            <div class="dashboard-card">
                <div class="card-header">
                    <div class="card-title">
                        <i class="fas fa-history"></i>
                        <span>Recent Calls</span>
                    </div>
                    <button class="btn-outline btn-sm" onclick="loadCallHistory()">Refresh</button>
                </div>
                
                <div class="call-history" id="callHistory">
                    <div class="empty-history">
                        <i class="fas fa-history"></i>
                        <h3>No calls yet</h3>
                        <p>Start your first conversation!</p>
                        <a href="index.html#whispers" class="btn-primary" style="margin-top: 20px;">
                            <i class="fas fa-phone-alt"></i> Find Whispers
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-brand">
                    <i class="fas fa-comment-dots"></i>
                    <span>Whisper+Me</span>
                    <p style="margin-top: 15px; max-width: 300px; font-size: 1.1rem !important;">
                        Connecting people through meaningful conversations.
                    </p>
                </div>
                
                <div class="footer-links">
                    <h4>Platform</h4>
                    <a href="index.html#whispers">Find Whispers</a>
                    <a href="index.html#how-it-works">How It Works</a>
                    <a href="payment.html">Buy Coins</a>
                    <a href="become-whisper.html">Become a Whisper</a>
                </div>
                
                <div class="footer-links">
                    <h4>Support</h4>
                    <a href="faq.html">FAQ</a>
                    <a href="guidelines.html">Community Guidelines</a>
                    <a href="contact.html">Contact Us</a>
                    <a href="status.html">Service Status</a>
                </div>
            </div>
            
            <div class="footer-bottom">
                <p>&copy; 2024 Whisper+Me. All rights reserved.</p>
                <div class="footer-legal">
                    <a href="terms.html">Terms</a>
                    <a href="privacy.html">Privacy</a>
                    <a href="guidelines.html">Guidelines</a>
                </div>
            </div>
        </div>
    </footer>

    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    
    <script src="firebase-config.js"></script>
    <script src="scripts.js"></script>
    
    <script>
        // Dashboard initialization
        let dashboardInitialized = false;
        
        function initializeDashboard() {
            if (dashboardInitialized) return;
            dashboardInitialized = true;
            
            console.log("ðŸ”§ Initializing dashboard...");
            console.log("Current user on dashboard init:", currentUser);
            console.log("User data on dashboard init:", userData);
            
            initMobileMenu();
            
            // Use auth state to determine if user is logged in
            auth.onAuthStateChanged((user) => {
                console.log("ðŸ”„ Dashboard auth state changed:", user ? "Logged in" : "Logged out");
                
                if (!user) {
                    console.log("âš ï¸ User not logged in on dashboard, showing message");
                    showToast('Please log in to view dashboard', 'warning');
                    setTimeout(() => {
                        window.location.href = 'index.html';
                    }, 2000);
                    return;
                }
                
                // User is logged in, proceed with dashboard
                console.log("âœ… User is logged in, loading dashboard data");
                
                // Wait for userData to load
                const checkUserData = setInterval(() => {
                    if (userData) {
                        clearInterval(checkUserData);
                        loadDashboardData();
                        
                        // Setup logout button
                        const logoutBtn = document.getElementById('logoutBtn');
                        if (logoutBtn) {
                            logoutBtn.addEventListener('click', logoutUser);
                        }
                        
                        // Update user nav
                        const userNav = document.getElementById('userNav');
                        if (userNav && userData.displayName) {
                            userNav.textContent = userData.displayName || user.email || 'User';
                        }
                    }
                }, 100);
            });
        }
        
        async function loadDashboardData() {
            if (!userData) {
                console.log('Waiting for user data...');
                setTimeout(loadDashboardData, 1000);
                return;
            }
            
            console.log("ðŸ“Š Loading dashboard data for user:", userData);
            
            // Update coin balance
            document.getElementById('coinBalance').textContent = userData.coins || 0;
            
            // Update total calls
            document.getElementById('totalCalls').textContent = userData.totalCalls || 0;
            
            // Update rating
            const rating = userData.rating || 5.0;
            document.getElementById('userRating').textContent = rating.toFixed(1);
            
            // Update star rating
            updateStarRating(rating);
            
            // Update role management
            updateRoleUI();
            
            // Load call history
            await loadCallHistory();
        }
        
        function updateStarRating(rating) {
            const starRating = document.getElementById('starRating');
            const fullStars = Math.floor(rating);
            const hasHalfStar = rating % 1 >= 0.5;
            
            let stars = '';
            for (let i = 1; i <= 5; i++) {
                if (i <= fullStars) {
                    stars += 'â˜…';
                } else if (i === fullStars + 1 && hasHalfStar) {
                    stars += 'Â½';
                } else {
                    stars += 'â˜†';
                }
            }
            starRating.innerHTML = stars;
        }
        
        function updateRoleUI() {
            const role = userData.role || 'caller';
            const isAvailable = userData.isAvailable || false;
            
            console.log("Updating role UI. Role:", role, "Available:", isAvailable);
            
            // Update role toggle
            const roleToggle = document.getElementById('roleToggle');
            if (roleToggle) {
                roleToggle.checked = role === 'whisper';
            }
            
            // Update role label and description
            const roleLabel = document.getElementById('roleLabel');
            const roleDescription = document.getElementById('roleDescription');
            const callerDescription = document.getElementById('callerDescription');
            const whisperDescription = document.getElementById('whisperDescription');
            const availabilitySection = document.getElementById('availabilitySection');
            const startWhisperingBtn = document.getElementById('startWhisperingBtn');
            
            if (role === 'whisper') {
                if (roleLabel) roleLabel.textContent = 'Whisper Mode';
                if (roleDescription) roleDescription.textContent = 'You are currently a whisper. Switch to caller mode to connect with other whispers.';
                if (callerDescription) callerDescription.style.display = 'none';
                if (whisperDescription) whisperDescription.style.display = 'block';
                if (availabilitySection) availabilitySection.style.display = 'block';
                
                if (startWhisperingBtn) {
                    startWhisperingBtn.innerHTML = '<i class="fas fa-phone"></i> <span>Take a Call</span>';
                    startWhisperingBtn.onclick = () => {
                        showToast('Check the whispers page to see available calls!', 'info');
                        setTimeout(() => {
                            window.location.href = 'index.html#whispers';
                        }, 1500);
                    };
                }
                
                // Update availability
                const availabilityToggle = document.getElementById('availabilityToggle');
                const statusIndicator = document.getElementById('statusIndicator');
                const statusText = document.getElementById('statusText');
                
                if (availabilityToggle) availabilityToggle.checked = isAvailable;
                if (statusIndicator) statusIndicator.className = 'status-indicator ' + (isAvailable ? 'available' : '');
                if (statusText) statusText.textContent = isAvailable ? 'Currently available for calls' : 'Currently unavailable';
                
            } else {
                if (roleLabel) roleLabel.textContent = 'Caller Mode';
                if (roleDescription) roleDescription.textContent = 'You are currently a caller. Switch to whisper mode to earn coins by taking calls.';
                if (callerDescription) callerDescription.style.display = 'block';
                if (whisperDescription) whisperDescription.style.display = 'none';
                if (availabilitySection) availabilitySection.style.display = 'none';
                
                if (startWhisperingBtn) {
                    startWhisperingBtn.innerHTML = '<i class="fas fa-broadcast-tower"></i> <span>Start Whispering</span>';
                    startWhisperingBtn.onclick = () => {
                        const roleToggle = document.getElementById('roleToggle');
                        if (roleToggle) {
                            roleToggle.checked = true;
                            handleRoleToggle();
                        }
                    };
                }
            }
        }
        
        function handleRoleToggle() {
            const roleToggle = document.getElementById('roleToggle');
            const newRole = roleToggle.checked ? 'whisper' : 'caller';
            
            if (confirm(`Are you sure you want to switch to ${newRole} mode?`)) {
                switchUserRole(newRole);
            } else {
                // Revert toggle
                roleToggle.checked = !roleToggle.checked;
                updateRoleUI();
            }
        }
        
        function handleAvailabilityToggle() {
            const availabilityToggle = document.getElementById('availabilityToggle');
            const isAvailable = availabilityToggle.checked;
            
            updateWhisperAvailability(isAvailable);
        }
        
        function startAsWhisper() {
            if (userData.role === 'caller') {
                const roleToggle = document.getElementById('roleToggle');
                if (roleToggle) {
                    roleToggle.checked = true;
                    handleRoleToggle();
                }
            } else {
                showToast('Check the whispers page to see available calls!', 'info');
                setTimeout(() => {
                    window.location.href = 'index.html#whispers';
                }, 1500);
            }
        }
        
        async function loadCallHistory() {
            const historyContainer = document.getElementById('callHistory');
            
            try {
                const calls = await getUserCallHistory(5);
                
                if (calls.length === 0) {
                    historyContainer.innerHTML = `
                        <div class="empty-history">
                            <i class="fas fa-history"></i>
                            <h3>No calls yet</h3>
                            <p>Start your first conversation!</p>
                            <a href="index.html#whispers" class="btn-primary" style="margin-top: 20px;">
                                <i class="fas fa-phone-alt"></i> Find Whispers
                            </a>
                        </div>
                    `;
                    return;
                }
                
                let html = '';
                calls.forEach(call => {
                    const startTime = call.startTime ? call.startTime.toDate() : new Date();
                    const duration = call.duration || 0;
                    
                    html += `
                        <div class="history-item">
                            <div class="history-info">
                                <h4>${formatDate(startTime)}</h4>
                                <p>${call.status || 'completed'}</p>
                            </div>
                            <div class="history-duration">
                                ${formatDuration(duration)}
                            </div>
                        </div>
                    `;
                });
                
                historyContainer.innerHTML = html;
                
            } catch (error) {
                console.error('Error loading call history:', error);
                historyContainer.innerHTML = `
                    <div class="empty-history">
                        <i class="fas fa-exclamation-triangle"></i>
                        <h3>Error loading history</h3>
                        <p>Please try again later</p>
                    </div>
                `;
            }
        }
        
        // Initialize dashboard when page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log("ðŸ  Dashboard DOM loaded");
            initializeDashboard();
            
            // Setup role toggle
            const roleToggle = document.getElementById('roleToggle');
            if (roleToggle) {
                roleToggle.addEventListener('change', handleRoleToggle);
            }
            
            // Setup availability toggle
            const availabilityToggle = document.getElementById('availabilityToggle');
            if (availabilityToggle) {
                availabilityToggle.addEventListener('change', handleAvailabilityToggle);
            }
            
            // Add redirect blocker
            window.addEventListener('beforeunload', function(e) {
                console.log("Page unloading, current URL:", window.location.href);
            });
        });
        
        // Monitor for any redirects
        let lastUrl = window.location.href;
        setInterval(() => {
            if (window.location.href !== lastUrl) {
                console.log("ðŸš¨ UNEXPECTED REDIRECT DETECTED!");
                console.log("From:", lastUrl);
                console.log("To:", window.location.href);
                console.trace("Stack trace:");
                lastUrl = window.location.href;
            }
        }, 100);
        <script>
// Listen for incoming calls
firebase.auth().onAuthStateChanged((user) => {
    if (user && user.uid) {
        // Listen for calls where user is participant and status is ringing
        firebase.firestore().collection('calls')
            .where('participants', 'array-contains', user.uid)
            .where('status', '==', 'ringing')
            .onSnapshot((snapshot) => {
                snapshot.docChanges().forEach((change) => {
                    if (change.type === 'added') {
                        const call = change.doc.data();
                        console.log('INCOMING CALL!', call);
                        
                        // Show notification
                        if (Notification.permission === 'granted') {
                            new Notification('ðŸ“ž Incoming Call!', {
                                body: 'Click to join the chat',
                                icon: '/icon.png'
                            });
                        }
                        
                        // Auto-redirect after 5 seconds
                        setTimeout(() => {
                            window.location.href = `call.html?callId=${change.doc.id}`;
                        }, 5000);
                    }
                });
            });
    }
});
</script>
</body>
</html>

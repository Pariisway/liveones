<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="google-adsense-account" content="ca-pub-1184595877548269">
    <title>Dashboard | Whisper+Me</title>
    
    <!-- Google AdSense -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1184595877548269" crossorigin="anonymous"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Montserrat:wght@800;900&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="styles.css">
    <link rel="icon" type="image/x-icon" href="assets/favicon.ico">
    
    <!-- Enhanced Dashboard Specific Styles -->
    <style>
        .enhanced-dashboard {
            padding-top: 100px;
            min-height: 100vh;
        }
        
        .dashboard-header {
            background: var(--card-bg);
            border-radius: var(--radius);
            padding: 30px;
            margin-bottom: 30px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 20px;
        }
        
        .user-header-info {
            display: flex;
            align-items: center;
            gap: 25px;
        }
        
        .user-avatar-editable {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: var(--gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 48px;
            color: white;
            position: relative;
            overflow: hidden;
            cursor: pointer;
        }
        
        .user-avatar-editable img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .avatar-upload-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .user-avatar-editable:hover .avatar-upload-overlay {
            opacity: 1;
        }
        
        .user-info h1 {
            font-size: 2rem;
            margin-bottom: 10px;
        }
        
        .user-role {
            display: inline-block;
            padding: 5px 15px;
            background: rgba(108, 99, 255, 0.1);
            color: var(--primary);
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
        }
        
        .dashboard-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            overflow-x: auto;
            padding-bottom: 5px;
        }
        
        .dashboard-tab {
            padding: 12px 24px;
            background: var(--card-bg);
            border: none;
            color: var(--gray);
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: var(--transition);
            white-space: nowrap;
        }
        
        .dashboard-tab:hover {
            background: rgba(108, 99, 255, 0.1);
            color: var(--primary);
        }
        
        .dashboard-tab.active {
            background: var(--primary);
            color: white;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 30px;
            margin-bottom: 40px;
        }
        
        .dashboard-card {
            background: var(--card-bg);
            border-radius: var(--radius);
            padding: 30px;
            transition: var(--transition);
        }
        
        .dashboard-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow);
        }
        
        .card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }
        
        .card-title {
            font-size: 1.3rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .card-title i {
            color: var(--primary);
        }
        
        .card-value {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 20px;
            background: var(--gradient);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
        }
        
        .stat-card {
            text-align: center;
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
        }
        
        .stat-value {
            font-size: 1.8rem;
            font-weight: 700;
            display: block;
            margin-bottom: 5px;
        }
        
        .stat-label {
            color: var(--gray);
            font-size: 0.9rem;
        }
        
        .banking-form {
            display: grid;
            gap: 20px;
            margin-top: 20px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 10px;
            font-weight: 500;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            color: white;
            font-family: 'Poppins', sans-serif;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        .payout-history {
            margin-top: 30px;
        }
        
        .payout-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        .payout-table th,
        .payout-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .payout-table th {
            background: rgba(108, 99, 255, 0.1);
            color: var(--primary);
            font-weight: 600;
        }
        
        .payout-status {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .status-pending { background: rgba(237, 137, 54, 0.2); color: var(--warning); }
        .status-paid { background: rgba(72, 187, 120, 0.2); color: var(--success); }
        .status-failed { background: rgba(245, 101, 101, 0.2); color: var(--danger); }
        
        .call-history-container {
            overflow-x: auto;
        }
        
        .call-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .call-table th,
        .call-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            white-space: nowrap;
        }
        
        .call-table th {
            background: rgba(108, 99, 255, 0.1);
            color: var(--primary);
            font-weight: 600;
        }
        
        .call-action-btn {
            padding: 5px 10px;
            background: rgba(108, 99, 255, 0.1);
            border: none;
            border-radius: 4px;
            color: var(--primary);
            cursor: pointer;
            font-size: 0.8rem;
        }
        
        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 30px;
        }
        
        .setting-item {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .setting-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
        }
        
        .setting-title {
            font-size: 1.1rem;
            font-weight: 600;
        }
        
        .setting-description {
            color: var(--gray);
            font-size: 0.9rem;
            margin-bottom: 15px;
        }
        
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--gray-dark);
            transition: .4s;
            border-radius: 34px;
        }
        
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .toggle-slider {
            background-color: var(--primary);
        }
        
        input:checked + .toggle-slider:before {
            transform: translateX(26px);
        }
        
        .quick-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }
        
        .action-btn {
            padding: 20px;
            background: rgba(108, 99, 255, 0.1);
            border: 2px solid transparent;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 15px;
            cursor: pointer;
            transition: var(--transition);
            text-decoration: none;
            color: white;
            text-align: center;
        }
        
        .action-btn:hover {
            background: rgba(108, 99, 255, 0.2);
            border-color: var(--primary);
            transform: translateY(-3px);
        }
        
        .action-btn i {
            font-size: 32px;
            color: var(--primary);
        }
        
        .empty-state {
            text-align: center;
            padding: 40px;
            color: var(--gray);
        }
        
        .empty-state i {
            font-size: 48px;
            margin-bottom: 20px;
            opacity: 0.5;
        }
        
        .file-upload {
            position: relative;
            margin-bottom: 20px;
        }
        
        .file-upload input {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
        }
        
        .upload-area {
            border: 2px dashed rgba(108, 99, 255, 0.3);
            border-radius: 8px;
            padding: 40px 20px;
            text-align: center;
            transition: var(--transition);
        }
        
        .upload-area:hover {
            border-color: var(--primary);
            background: rgba(108, 99, 255, 0.05);
        }
        
        .upload-area i {
            font-size: 48px;
            color: var(--primary);
            margin-bottom: 15px;
        }
        
        .profile-preview {
            text-align: center;
            margin-top: 20px;
        }
        
        .preview-image {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            object-fit: cover;
            margin: 0 auto 15px;
            border: 3px solid var(--primary);
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-brand">
                <i class="fas fa-comment-dots"></i>
                <span>Whisper+Me</span>
            </div>
            
            <div class="nav-menu">
                <a href="index.html" class="nav-link">Home</a>
                <a href="index.html#whispers" class="nav-link">Whispers</a>
                <a href="index.html#how-it-works" class="nav-link">How It Works</a>
                <a href="payment.html" class="nav-link">Buy Coins</a>
            </div>
            
            <div class="nav-actions">
                <span id="userNav" class="nav-user">User</span>
                <button id="logoutBtn" class="btn-outline">Log Out</button>
            </div>
            
            <button class="mobile-menu-btn">
                <i class="fas fa-bars"></i>
            </button>
        </div>
    </nav>

    <!-- Enhanced Dashboard -->
    <div class="enhanced-dashboard">
        <div class="container">
            <!-- Dashboard Header -->
            <div class="dashboard-header">
                <div class="user-header-info">
                    <div class="user-avatar-editable" id="avatarUploadContainer">
                        <div id="avatarDisplay">
                            <i class="fas fa-user"></i>
                        </div>
                        <div class="avatar-upload-overlay">
                            <i class="fas fa-camera"></i>
                            <small>Click to upload</small>
                        </div>
                        <input type="file" id="avatarUpload" accept="image/*" style="display: none;">
                    </div>
                    <div class="user-info">
                        <h1 id="dashboardName">Loading...</h1>
                        <span class="user-role" id="userRole">Caller</span>
                        <p id="userEmail" style="color: var(--gray); margin-top: 10px;">user@example.com</p>
                    </div>
                </div>
                <div class="dashboard-stats-quick">
                    <div class="card-value" id="coinBalance">0</div>
                    <div style="text-align: center; color: var(--gray);">Whisper Coins</div>
                </div>
            </div>
            
            <!-- Dashboard Tabs -->
            <div class="dashboard-tabs">
                <button class="dashboard-tab active" data-tab="overview">
                    <i class="fas fa-tachometer-alt"></i> Overview
                </button>
                <button class="dashboard-tab" data-tab="profile">
                    <i class="fas fa-user-edit"></i> Profile
                </button>
                <button class="dashboard-tab" data-tab="banking" id="bankingTab" style="display: none;">
                    <i class="fas fa-wallet"></i> Banking
                </button>
                <button class="dashboard-tab" data-tab="calls">
                    <i class="fas fa-phone-alt"></i> Call History
                </button>
                <button class="dashboard-tab" data-tab="earnings" id="earningsTab" style="display: none;">
                    <i class="fas fa-money-bill-wave"></i> Earnings
                </button>
                <button class="dashboard-tab" data-tab="settings">
                    <i class="fas fa-cog"></i> Settings
                </button>
            </div>
            
            <!-- Overview Tab -->
            <div id="overview" class="tab-content active">
                <div class="dashboard-grid">
                    <!-- Balance Card -->
                    <div class="dashboard-card">
                        <div class="card-header">
                            <h3 class="card-title">
                                <i class="fas fa-coins"></i> Whisper Coins
                            </h3>
                            <button class="btn-primary" onclick="window.location.href='payment.html'">
                                <i class="fas fa-shopping-cart"></i> Buy More
                            </button>
                        </div>
                        <div class="card-value" id="overviewCoinBalance">0</div>
                        <p style="color: var(--gray); margin-bottom: 20px;">
                            Each coin = 1 call. Calls last 5 minutes.
                        </p>
                        <div class="quick-actions">
                            <a href="payment.html" class="action-btn">
                                <i class="fas fa-credit-card"></i>
                                <span>Buy Coins</span>
                            </a>
                            <a href="index.html#whispers" class="action-btn">
                                <i class="fas fa-phone-alt"></i>
                                <span>Start a Call</span>
                            </a>
                            <a href="#" class="action-btn" id="coinHistoryBtn">
                                <i class="fas fa-history"></i>
                                <span>Coin History</span>
                            </a>
                        </div>
                    </div>
                    
                    <!-- Stats Card -->
                    <div class="dashboard-card">
                        <div class="card-header">
                            <h3 class="card-title">
                                <i class="fas fa-chart-line"></i> Your Stats
                            </h3>
                        </div>
                        <div class="stats-grid">
                            <div class="stat-card">
                                <span class="stat-value" id="overviewTotalCalls">0</span>
                                <span class="stat-label">Total Calls</span>
                            </div>
                            <div class="stat-card">
                                <span class="stat-value" id="overviewCallRating">5.0</span>
                                <span class="stat-label">Rating</span>
                            </div>
                            <div class="stat-card">
                                <span class="stat-value" id="overviewAvgDuration">5:00</span>
                                <span class="stat-label">Avg. Duration</span>
                            </div>
                            <div class="stat-card">
                                <span class="stat-value" id="overviewResponseRate">100%</span>
                                <span class="stat-label">Response Rate</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Quick Actions -->
                    <div class="dashboard-card">
                        <div class="card-header">
                            <h3 class="card-title">
                                <i class="fas fa-bolt"></i> Quick Actions
                            </h3>
                        </div>
                        <div class="quick-actions">
                            <a href="index.html#whispers" class="action-btn">
                                <i class="fas fa-phone-alt"></i>
                                <span>Start a Call</span>
                            </a>
                            <a href="#" class="action-btn" id="editProfileBtn">
                                <i class="fas fa-user-edit"></i>
                                <span>Edit Profile</span>
                            </a>
                            <a href="#" class="action-btn" id="viewHistoryBtn">
                                <i class="fas fa-history"></i>
                                <span>Call History</span>
                            </a>
                            <a href="#" class="action-btn" id="inviteFriendsBtn">
                                <i class="fas fa-user-plus"></i>
                                <span>Invite Friends</span>
                            </a>
                        </div>
                        
                        <!-- Whisper Controls -->
                        <div id="whisperControls" style="display: none; margin-top: 30px;">
                            <div class="setting-item">
                                <div class="setting-header">
                                    <div>
                                        <div class="setting-title">Availability</div>
                                        <div class="setting-description">Turn on to receive calls</div>
                                    </div>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="availabilityToggle">
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Recent Activity -->
                <div class="dashboard-card" style="margin-top: 30px;">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-history"></i> Recent Activity
                        </h3>
                    </div>
                    <div class="call-history-container">
                        <table class="call-table">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Type</th>
                                    <th>With</th>
                                    <th>Duration</th>
                                    <th>Status</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody id="recentActivityBody">
                                <!-- Recent activity will be populated -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Profile Tab -->
            <div id="profile" class="tab-content">
                <div class="dashboard-card">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-user-edit"></i> Edit Profile
                        </h3>
                    </div>
                    
                    <form id="enhancedProfileForm">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="editDisplayName">Display Name *</label>
                                <input type="text" id="editDisplayName" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="editCategory">Category</label>
                                <select id="editCategory">
                                    <option value="entertainment">Entertainment</option>
                                    <option value="gaming">Gaming</option>
                                    <option value="music">Music</option>
                                    <option value="sports">Sports</option>
                                    <option value="education">Education</option>
                                    <option value="business">Business</option>
                                    <option value="lifestyle">Lifestyle</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="editBio">Bio *</label>
                            <textarea id="editBio" rows="4" required placeholder="Tell users about yourself..."></textarea>
                            <small style="color: var(--gray);">Minimum 100 characters</small>
                        </div>
                        
                        <div class="form-group">
                            <label>Profile Picture</label>
                            <div class="file-upload">
                                <div class="upload-area">
                                    <i class="fas fa-cloud-upload-alt"></i>
                                    <h4>Drag & Drop or Click to Upload</h4>
                                    <p>Maximum file size: 5MB. Supported formats: JPG, PNG, GIF</p>
                                    <input type="file" id="profilePictureUpload" accept="image/*">
                                </div>
                            </div>
                            <div class="profile-preview" id="profilePreview" style="display: none;">
                                <img id="profilePreviewImage" class="preview-image" src="" alt="Preview">
                                <button type="button" class="btn-outline" id="removeProfilePicture">
                                    <i class="fas fa-trash"></i> Remove Picture
                                </button>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>Social Links</label>
                            <div style="display: grid; gap: 15px; margin-top: 10px;">
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <i class="fab fa-instagram" style="color: #E1306C;"></i>
                                    <input type="text" id="editInstagram" placeholder="Instagram username">
                                </div>
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <i class="fab fa-twitter" style="color: #1DA1F2;"></i>
                                    <input type="text" id="editTwitter" placeholder="Twitter username">
                                </div>
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <i class="fab fa-tiktok" style="color: #000000;"></i>
                                    <input type="text" id="editTiktok" placeholder="TikTok username">
                                </div>
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <i class="fab fa-youtube" style="color: #FF0000;"></i>
                                    <input type="text" id="editYoutube" placeholder="YouTube channel URL">
                                </div>
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <i class="fab fa-twitch" style="color: #9146FF;"></i>
                                    <input type="text" id="editTwitch" placeholder="Twitch username">
                                </div>
                            </div>
                        </div>
                        
                        <button type="submit" class="btn-primary btn-block">
                            <i class="fas fa-save"></i> Save Changes
                        </button>
                    </form>
                </div>
            </div>
            
            <!-- Banking Tab -->
            <div id="banking" class="tab-content">
                <div class="dashboard-card">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-wallet"></i> Banking & Payouts
                        </h3>
                    </div>
                    
                    <div id="bankingInfo">
                        <p style="color: var(--gray); margin-bottom: 20px;">
                            Set up your payment method to receive earnings from calls.
                        </p>
                        
                        <form id="bankingForm">
                            <div class="form-group">
                                <label for="paymentMethod">Payment Method *</label>
                                <select id="paymentMethod" required>
                                    <option value="">Select Method</option>
                                    <option value="paypal">PayPal</option>
                                    <option value="bank">Bank Transfer</option>
                                    <option value="stripe">Stripe Connect</option>
                                    <option value="cashapp">Cash App</option>
                                </select>
                            </div>
                            
                            <div id="paypalFields" style="display: none;">
                                <div class="form-group">
                                    <label for="paypalEmail">PayPal Email *</label>
                                    <input type="email" id="paypalEmail">
                                </div>
                            </div>
                            
                            <div id="bankFields" style="display: none;">
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="bankName">Bank Name *</label>
                                        <input type="text" id="bankName">
                                    </div>
                                    <div class="form-group">
                                        <label for="accountNumber">Account Number *</label>
                                        <input type="text" id="accountNumber">
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="routingNumber">Routing Number *</label>
                                        <input type="text" id="routingNumber">
                                    </div>
                                    <div class="form-group">
                                        <label for="accountType">Account Type *</label>
                                        <select id="accountType">
                                            <option value="checking">Checking</option>
                                            <option value="savings">Savings</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label for="taxId">Tax ID (SSN/EIN)</label>
                                <input type="text" id="taxId" placeholder="For tax reporting purposes">
                                <small style="color: var(--gray);">Required for US users earning over $600/year</small>
                            </div>
                            
                            <button type="submit" class="btn-primary btn-block">
                                <i class="fas fa-save"></i> Save Banking Info
                            </button>
                        </form>
                    </div>
                    
                    <!-- Payout History -->
                    <div class="payout-history" id="payoutHistory" style="display: none;">
                        <h3 style="margin-top: 40px; margin-bottom: 20px;">Payout History</h3>
                        <table class="payout-table">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Amount</th>
                                    <th>Method</th>
                                    <th>Status</th>
                                    <th>Reference</th>
                                </tr>
                            </thead>
                            <tbody id="payoutHistoryBody">
                                <!-- Payout history will be populated -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Call History Tab -->
            <div id="calls" class="tab-content">
                <div class="dashboard-card">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-phone-alt"></i> Call History
                        </h3>
                        <div style="display: flex; gap: 10px;">
                            <select id="callHistoryFilter" style="background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 8px; padding: 8px 15px; color: white;">
                                <option value="all">All Calls</option>
                                <option value="completed">Completed</option>
                                <option value="missed">Missed</option>
                                <option value="refunded">Refunded</option>
                            </select>
                            <input type="date" id="callHistoryDate" style="background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 8px; padding: 8px 15px; color: white;">
                        </div>
                    </div>
                    
                    <div class="call-history-container">
                        <table class="call-table">
                            <thead>
                                <tr>
                                    <th>Date & Time</th>
                                    <th>Type</th>
                                    <th>With</th>
                                    <th>Duration</th>
                                    <th>Cost/Earnings</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="fullCallHistoryBody">
                                <!-- Call history will be populated -->
                            </tbody>
                        </table>
                    </div>
                    
                    <div style="text-align: center; margin-top: 30px;">
                        <button class="btn-outline" id="loadMoreCalls">
                            <i class="fas fa-spinner fa-spin" style="display: none;"></i>
                            Load More Calls
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Earnings Tab -->
            <div id="earnings" class="tab-content">
                <div class="dashboard-card">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-money-bill-wave"></i> Earnings Dashboard
                        </h3>
                        <button class="btn-primary" id="requestPayoutBtn">
                            <i class="fas fa-dollar-sign"></i> Request Payout
                        </button>
                    </div>
                    
                    <div class="stats-grid" style="margin-bottom: 30px;">
                        <div class="stat-card">
                            <span class="stat-value" id="totalEarnings">$0</span>
                            <span class="stat-label">Total Earnings</span>
                        </div>
                        <div class="stat-card">
                            <span class="stat-value" id="availableEarnings">$0</span>
                            <span class="stat-label">Available for Payout</span>
                        </div>
                        <div class="stat-card">
                            <span class="stat-value" id="pendingEarnings">$0</span>
                            <span class="stat-label">Pending Payout</span>
                        </div>
                        <div class="stat-card">
                            <span class="stat-value" id="lifetimeEarnings">$0</span>
                            <span class="stat-label">Lifetime Earnings</span>
                        </div>
                    </div>
                    
                    <!-- Earnings Chart Placeholder -->
                    <div style="background: rgba(255, 255, 255, 0.05); border-radius: 8px; padding: 30px; margin-bottom: 30px; text-align: center;">
                        <h4 style="margin-bottom: 20px;">Earnings Overview</h4>
                        <div id="earningsChart" style="height: 200px; display: flex; align-items: center; justify-content: center; color: var(--gray);">
                            <div>
                                <i class="fas fa-chart-bar" style="font-size: 48px; margin-bottom: 10px;"></i>
                                <p>Earnings chart will appear here</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Payout History -->
                    <h3 style="margin-bottom: 20px;">Payout History</h3>
                    <table class="payout-table">
                        <thead>
                            <tr>
                                <th>Date Requested</th>
                                <th>Date Paid</th>
                                <th>Amount</th>
                                <th>Method</th>
                                <th>Status</th>
                                <th>Reference</th>
                            </tr>
                        </thead>
                        <tbody id="whisperPayoutHistoryBody">
                            <!-- Whisper payout history will be populated -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Settings Tab -->
            <div id="settings" class="tab-content">
                <div class="settings-grid">
                    <div class="dashboard-card">
                        <h3 class="card-title" style="margin-bottom: 25px;">
                            <i class="fas fa-bell"></i> Notifications
                        </h3>
                        
                        <div class="setting-item">
                            <div class="setting-header">
                                <div>
                                    <div class="setting-title">Email Notifications</div>
                                    <div class="setting-description">Receive emails about calls and earnings</div>
                                </div>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="emailNotifications" checked>
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                        </div>
                        
                        <div class="setting-item">
                            <div class="setting-header">
                                <div>
                                    <div class="setting-title">Push Notifications</div>
                                    <div class="setting-description">Browser notifications for calls</div>
                                </div>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="pushNotifications" checked>
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                        </div>
                        
                        <div class="setting-item">
                            <div class="setting-header">
                                <div>
                                    <div class="setting-title">Sound Alerts</div>
                                    <div class="setting-description">Play sound when receiving calls</div>
                                </div>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="soundAlerts" checked>
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="dashboard-card">
                        <h3 class="card-title" style="margin-bottom: 25px;">
                            <i class="fas fa-shield-alt"></i> Privacy & Security
                        </h3>
                        
                        <div class="setting-item">
                            <div class="setting-header">
                                <div>
                                    <div class="setting-title">Profile Visibility</div>
                                    <div class="setting-description">Make your profile public</div>
                                </div>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="profileVisibility" checked>
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                        </div>
                        
                        <div class="setting-item">
                            <div class="setting-header">
                                <div>
                                    <div class="setting-title">Two-Factor Authentication</div>
                                    <div class="setting-description">Add extra security to your account</div>
                                </div>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="twoFactorAuth">
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                        </div>
                        
                        <div class="setting-item">
                            <div class="setting-header">
                                <div>
                                    <div class="setting-title">Show Online Status</div>
                                    <div class="setting-description">Let others see when you're online</div>
                                </div>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="onlineStatus" checked>
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                        </div>
                        
                        <button class="btn-outline btn-block mt-20" id="changePasswordBtn">
                            <i class="fas fa-key"></i> Change Password
                        </button>
                    </div>
                </div>
                
                <!-- Account Management -->
                <div class="dashboard-card" style="margin-top: 30px;">
                    <h3 class="card-title" style="margin-bottom: 25px;">
                        <i class="fas fa-user-cog"></i> Account Management
                    </h3>
                    
                    <div class="quick-actions">
                        <button class="action-btn" id="exportDataBtn">
                            <i class="fas fa-download"></i>
                            <span>Export Data</span>
                        </button>
                        <button class="action-btn" id="downloadTaxFormsBtn">
                            <i class="fas fa-file-invoice-dollar"></i>
                            <span>Tax Forms</span>
                        </button>
                        <button class="action-btn" id="deactivateAccountBtn">
                            <i class="fas fa-user-slash"></i>
                            <span>Deactivate Account</span>
                        </button>
                        <button class="action-btn danger" id="deleteAccountBtn">
                            <i class="fas fa-trash"></i>
                            <span>Delete Account</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div class="modal" id="avatarUploadModal">
        <div class="modal-content" style="max-width: 500px; text-align: center;">
            <button class="modal-close">&times;</button>
            <h2 style="margin-bottom: 20px;">Upload Profile Picture</h2>
            
            <div class="file-upload">
                <div class="upload-area" id="avatarUploadArea">
                    <i class="fas fa-cloud-upload-alt"></i>
                    <h4>Drag & Drop or Click to Upload</h4>
                    <p>Maximum file size: 5MB. Supported formats: JPG, PNG, GIF</p>
                    <input type="file" id="modalAvatarUpload" accept="image/*">
                </div>
            </div>
            
            <div class="profile-preview" id="modalProfilePreview" style="display: none; margin-top: 20px;">
                <img id="modalPreviewImage" class="preview-image" src="" alt="Preview">
            </div>
            
            <div style="display: flex; gap: 15px; margin-top: 30px;">
                <button class="btn-primary" id="confirmAvatarUpload" style="flex: 1;">
                    <i class="fas fa-check"></i> Upload
                </button>
                <button class="btn-outline modal-close" style="flex: 1;">
                    Cancel
                </button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-storage-compat.js"></script>
    
    <script src="firebase-config.js"></script>
    <script src="scripts.js"></script>
    
    <!-- Enhanced Dashboard Specific Script -->
    <script>
        let avatarFile = null;
        let callHistoryLimit = 10;
        let lastCallDoc = null;
        
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize mobile menu
            initMobileMenu();
            
            // Check auth status
            if (!currentUser) {
                window.location.href = 'index.html';
                return;
            }
            
            // Load dashboard data
            loadEnhancedDashboardData();
            
            // Set up event listeners
            setupEnhancedDashboardEvents();
        });
        
        // Load enhanced dashboard data
        async function loadEnhancedDashboardData() {
            if (!currentUser || !userData) {
                await new Promise(resolve => setTimeout(resolve, 1000));
                if (!userData) {
                    window.location.href = 'index.html';
                    return;
                }
            }
            
            // Update user info
            document.getElementById('dashboardName').textContent = userData.displayName || 'User';
            document.getElementById('userEmail').textContent = userData.email || 'user@example.com';
            document.getElementById('userRole').textContent = userData.role === 'whisper' ? 'Whisper' : 'Caller';
            document.getElementById('userNav').textContent = userData.displayName || 'User';
            
            // Update avatar display
            updateAvatarDisplay();
            
            // Update coin balance
            document.getElementById('coinBalance').textContent = userData.coins || 0;
            document.getElementById('overviewCoinBalance').textContent = userData.coins || 0;
            
            // Update stats
            document.getElementById('overviewTotalCalls').textContent = userData.totalCalls || 0;
            document.getElementById('overviewCallRating').textContent = (userData.rating || 5.0).toFixed(1);
            document.getElementById('overviewAvgDuration').textContent = formatDuration(userData.avgDuration || 300);
            document.getElementById('overviewResponseRate').textContent = (userData.responseRate || 100) + '%';
            
            // Show/hide whisper-specific tabs
            if (userData.role === 'whisper') {
                document.getElementById('bankingTab').style.display = 'block';
                document.getElementById('earningsTab').style.display = 'block';
                document.getElementById('whisperControls').style.display = 'block';
                
                // Load earnings data
                await loadEarningsData();
                await loadPayoutHistory();
                
                // Setup availability toggle
                const toggle = document.getElementById('availabilityToggle');
                toggle.checked = userData.isAvailable || false;
            }
            
            // Load recent activity
            await loadRecentActivity();
            
            // Load full call history
            await loadFullCallHistory();
            
            // Populate profile form
            populateProfileForm();
            
            // Populate banking form if whisper
            if (userData.role === 'whisper') {
                populateBankingForm();
            }
        }
        
        // Update avatar display
        function updateAvatarDisplay() {
            const avatarDisplay = document.getElementById('avatarDisplay');
            if (userData.avatarUrl) {
                avatarDisplay.innerHTML = `<img src="${userData.avatarUrl}" alt="Profile" style="width: 100%; height: 100%; object-fit: cover;">`;
            } else {
                avatarDisplay.innerHTML = '<i class="fas fa-user"></i>';
            }
        }
        
        // Format duration
        function formatDuration(seconds) {
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            return `${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
        }
        
        // Load earnings data
        async function loadEarningsData() {
            const earnings = userData.earnings || 0;
            const pendingPayouts = userData.pendingPayouts || 0;
            const lifetimeEarnings = userData.lifetimeEarnings || earnings;
            const availableEarnings = Math.max(0, earnings - pendingPayouts);
            
            document.getElementById('totalEarnings').textContent = `$${earnings.toFixed(2)}`;
            document.getElementById('availableEarnings').textContent = `$${availableEarnings.toFixed(2)}`;
            document.getElementById('pendingEarnings').textContent = `$${pendingPayouts.toFixed(2)}`;
            document.getElementById('lifetimeEarnings').textContent = `$${lifetimeEarnings.toFixed(2)}`;
        }
        
        // Load payout history
        async function loadPayoutHistory() {
            try {
                const payoutsRef = db.collection('payouts')
                    .where('userId', '==', currentUser.uid)
                    .orderBy('requestedAt', 'desc')
                    .limit(10);
                
                const snapshot = await payoutsRef.get();
                const tbody = document.getElementById('whisperPayoutHistoryBody');
                
                if (snapshot.empty) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: var(--gray);">No payout history yet.</td></tr>';
                    return;
                }
                
                let rowsHTML = '';
                snapshot.forEach(doc => {
                    const payout = doc.data();
                    rowsHTML += createPayoutRow(payout);
                });
                
                tbody.innerHTML = rowsHTML;
                
            } catch (error) {
                console.error('Error loading payout history:', error);
            }
        }
        
        // Create payout row
        function createPayoutRow(payout) {
            const requestedDate = payout.requestedAt ? payout.requestedAt.toDate() : new Date();
            const paidDate = payout.paidAt ? payout.paidAt.toDate() : null;
            
            const formattedRequested = requestedDate.toLocaleDateString('en-US', {
                month: 'short',
                day: 'numeric',
                year: 'numeric'
            });
            
            const formattedPaid = paidDate ? paidDate.toLocaleDateString('en-US', {
                month: 'short',
                day: 'numeric',
                year: 'numeric'
            }) : '-';
            
            let statusClass = 'status-pending';
            let statusText = 'Pending';
            
            if (payout.status === 'paid') {
                statusClass = 'status-paid';
                statusText = 'Paid';
            } else if (payout.status === 'failed') {
                statusClass = 'status-failed';
                statusText = 'Failed';
            }
            
            return `
                <tr>
                    <td>${formattedRequested}</td>
                    <td>${formattedPaid}</td>
                    <td>$${payout.amount.toFixed(2)}</td>
                    <td>${payout.method || 'PayPal'}</td>
                    <td><span class="payout-status ${statusClass}">${statusText}</span></td>
                    <td>${payout.referenceId || '-'}</td>
                </tr>
            `;
        }
        
        // Load recent activity
        async function loadRecentActivity() {
            try {
                const callsRef = db.collection('calls')
                    .where('participants', 'array-contains', currentUser.uid)
                    .orderBy('startTime', 'desc')
                    .limit(5);
                
                const snapshot = await callsRef.get();
                const tbody = document.getElementById('recentActivityBody');
                
                if (snapshot.empty) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: var(--gray);">No recent activity.</td></tr>';
                    return;
                }
                
                let rowsHTML = '';
                snapshot.forEach(doc => {
                    const call = doc.data();
                    rowsHTML += createActivityRow(call, doc.id);
                });
                
                tbody.innerHTML = rowsHTML;
                
            } catch (error) {
                console.error('Error loading recent activity:', error);
            }
        }
        
        // Create activity row
        function createActivityRow(call, callId) {
            const otherUserId = call.participants.find(id => id !== currentUser.uid);
            const isWhisper = userData.role === 'whisper';
            const startTime = call.startTime ? call.startTime.toDate() : new Date();
            const duration = call.actualDuration || call.duration || 0;
            const status = call.status || 'completed';
            
            const formattedDate = startTime.toLocaleDateString('en-US', {
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
            
            let statusClass = 'status-completed';
            let statusText = 'Completed';
            
            if (status === 'missed') {
                statusClass = 'status-missed';
                statusText = 'Missed';
            } else if (status === 'refunded') {
                statusClass = 'status-missed';
                statusText = 'Refunded';
            }
            
            let actionButton = '';
            if (status === 'completed') {
                actionButton = `<button class="call-action-btn" onclick="viewCallDetails('${callId}')">Details</button>`;
            } else if (status === 'missed' && !isWhisper) {
                actionButton = `<button class="call-action-btn" onclick="retryCall('${otherUserId}')">Retry</button>`;
            }
            
            return `
                <tr>
                    <td>${formattedDate}</td>
                    <td>${isWhisper ? 'Outgoing' : 'Incoming'}</td>
                    <td>${isWhisper ? 'Caller' : 'Whisper'}</td>
                    <td>${formatDuration(duration)}</td>
                    <td><span class="call-status ${statusClass}">${statusText}</span></td>
                    <td>${actionButton}</td>
                </tr>
            `;
        }
        
        // Load full call history
        async function loadFullCallHistory(reset = true) {
            try {
                let callsRef = db.collection('calls')
                    .where('participants', 'array-contains', currentUser.uid)
                    .orderBy('startTime', 'desc')
                    .limit(callHistoryLimit);
                
                if (!reset && lastCallDoc) {
                    callsRef = callsRef.startAfter(lastCallDoc);
                }
                
                const snapshot = await callsRef.get();
                const tbody = document.getElementById('fullCallHistoryBody');
                
                if (snapshot.empty && reset) {
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: var(--gray);">No call history yet.</td></tr>';
                    return;
                }
                
                let rowsHTML = '';
                snapshot.forEach(doc => {
                    const call = doc.data();
                    rowsHTML += createFullCallHistoryRow(call, doc.id);
                    lastCallDoc = doc;
                });
                
                if (reset) {
                    tbody.innerHTML = rowsHTML;
                } else {
                    tbody.innerHTML += rowsHTML;
                }
                
                // Show/hide load more button
                const loadMoreBtn = document.getElementById('loadMoreCalls');
                if (snapshot.size < callHistoryLimit) {
                    loadMoreBtn.style.display = 'none';
                } else {
                    loadMoreBtn.style.display = 'block';
                }
                
            } catch (error) {
                console.error('Error loading call history:', error);
            }
        }
        
        // Create full call history row
        function createFullCallHistoryRow(call, callId) {
            const otherUserId = call.participants.find(id => id !== currentUser.uid);
            const isWhisper = userData.role === 'whisper';
            const startTime = call.startTime ? call.startTime.toDate() : new Date();
            const duration = call.actualDuration || call.duration || 0;
            const status = call.status || 'completed';
            const cost = call.cost || 0;
            const earnings = call.earnings || 0;
            
            const formattedDate = startTime.toLocaleDateString('en-US', {
                month: 'short',
                day: 'numeric',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
            
            let statusClass = 'status-completed';
            let statusText = 'Completed';
            
            if (status === 'missed') {
                statusClass = 'status-missed';
                statusText = 'Missed';
            } else if (status === 'refunded') {
                statusClass = 'status-missed';
                statusText = 'Refunded';
            }
            
            const amount = isWhisper ? `+$${earnings.toFixed(2)}` : `-${cost} coin${cost !== 1 ? 's' : ''}`;
            
            let actionButtons = '';
            if (status === 'completed') {
                actionButtons = `
                    <button class="call-action-btn" onclick="viewCallDetails('${callId}')" title="View Details">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button class="call-action-btn" onclick="downloadCallData('${callId}')" title="Download">
                        <i class="fas fa-download"></i>
                    </button>
                `;
            } else if (status === 'missed' && !isWhisper) {
                actionButtons = `
                    <button class="call-action-btn" onclick="retryCall('${otherUserId}')" title="Retry Call">
                        <i class="fas fa-redo"></i>
                    </button>
                `;
            }
            
            return `
                <tr>
                    <td>${formattedDate}</td>
                    <td>${isWhisper ? 'Outgoing' : 'Incoming'}</td>
                    <td>${isWhisper ? 'Caller' : 'Whisper'}</td>
                    <td>${formatDuration(duration)}</td>
                    <td>${amount}</td>
                    <td><span class="call-status ${statusClass}">${statusText}</span></td>
                    <td style="display: flex; gap: 5px;">${actionButtons}</td>
                </tr>
            `;
        }
        
        // Populate profile form
        function populateProfileForm() {
            document.getElementById('editDisplayName').value = userData.displayName || '';
            document.getElementById('editBio').value = userData.bio || '';
            document.getElementById('editCategory').value = userData.category || 'entertainment';
            document.getElementById('editInstagram').value = userData.socialLinks?.instagram || '';
            document.getElementById('editTwitter').value = userData.socialLinks?.twitter || '';
            document.getElementById('editTiktok').value = userData.socialLinks?.tiktok || '';
            document.getElementById('editYoutube').value = userData.socialLinks?.youtube || '';
            document.getElementById('editTwitch').value = userData.socialLinks?.twitch || '';
            
            // Show profile picture preview if exists
            if (userData.avatarUrl) {
                document.getElementById('profilePreview').style.display = 'block';
                document.getElementById('profilePreviewImage').src = userData.avatarUrl;
            }
        }
        
        // Populate banking form
        function populateBankingForm() {
            document.getElementById('paymentMethod').value = userData.paymentMethod || '';
            document.getElementById('paypalEmail').value = userData.paypalEmail || '';
            document.getElementById('bankName').value = userData.bankName || '';
            document.getElementById('accountNumber').value = userData.accountNumber || '';
            document.getElementById('routingNumber').value = userData.routingNumber || '';
            document.getElementById('accountType').value = userData.accountType || 'checking';
            document.getElementById('taxId').value = userData.taxId || '';
            
            // Show/hide payment method fields
            updatePaymentMethodFields();
            
            // Show payout history if exists
            if (userData.totalEarnings > 0) {
                document.getElementById('payoutHistory').style.display = 'block';
            }
        }
        
        // Setup enhanced dashboard event listeners
        function setupEnhancedDashboardEvents() {
            // Logout button
            document.getElementById('logoutBtn').addEventListener('click', logoutUser);
            
            // Tab switching
            document.querySelectorAll('.dashboard-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabId = this.getAttribute('data-tab');
                    
                    // Update active tab
                    document.querySelectorAll('.dashboard-tab').forEach(t => {
                        t.classList.remove('active');
                    });
                    this.classList.add('active');
                    
                    // Show corresponding tab content
                    document.querySelectorAll('.tab-content').forEach(content => {
                        content.classList.remove('active');
                    });
                    document.getElementById(tabId).classList.add('active');
                });
            });
            
            // Avatar upload
            document.getElementById('avatarUploadContainer').addEventListener('click', function() {
                document.getElementById('avatarUploadModal').classList.add('active');
            });
            
            // Profile picture upload in modal
            document.getElementById('modalAvatarUpload').addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    avatarFile = file;
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        document.getElementById('modalProfilePreview').style.display = 'block';
                        document.getElementById('modalPreviewImage').src = e.target.result;
                    };
                    reader.readAsDataURL(file);
                }
            });
            
            // Confirm avatar upload
            document.getElementById('confirmAvatarUpload').addEventListener('click', async function() {
                if (!avatarFile) {
                    showToast('Please select a file first', 'warning');
                    return;
                }
                
                try {
                    // Upload to Firebase Storage
                    const storageRef = storage.ref();
                    const avatarRef = storageRef.child(`avatars/${currentUser.uid}/${avatarFile.name}`);
                    const snapshot = await avatarRef.put(avatarFile);
                    const downloadURL = await snapshot.ref.getDownloadURL();
                    
                    // Update user document
                    await db.collection('users').doc(currentUser.uid).update({
                        avatarUrl: downloadURL,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    // Update local user data
                    userData.avatarUrl = downloadURL;
                    
                    // Update avatar display
                    updateAvatarDisplay();
                    document.getElementById('profilePreview').style.display = 'block';
                    document.getElementById('profilePreviewImage').src = downloadURL;
                    
                    showToast('Profile picture updated successfully!', 'success');
                    document.getElementById('avatarUploadModal').classList.remove('active');
                    avatarFile = null;
                    
                } catch (error) {
                    console.error('Error uploading avatar:', error);
                    showToast('Error uploading profile picture', 'error');
                }
            });
            
            // Remove profile picture
            document.getElementById('removeProfilePicture').addEventListener('click', async function() {
                try {
                    await db.collection('users').doc(currentUser.uid).update({
                        avatarUrl: firebase.firestore.FieldValue.delete(),
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    // Update local user data
                    userData.avatarUrl = null;
                    
                    // Update avatar display
                    updateAvatarDisplay();
                    document.getElementById('profilePreview').style.display = 'none';
                    
                    showToast('Profile picture removed', 'success');
                    
                } catch (error) {
                    console.error('Error removing avatar:', error);
                    showToast('Error removing profile picture', 'error');
                }
            });
            
            // Profile form submission
            document.getElementById('enhancedProfileForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const displayName = document.getElementById('editDisplayName').value;
                const bio = document.getElementById('editBio').value;
                
                if (bio.length < 100) {
                    showToast('Bio must be at least 100 characters', 'warning');
                    return;
                }
                
                const updates = {
                    displayName: displayName,
                    bio: bio,
                    category: document.getElementById('editCategory').value,
                    socialLinks: {
                        instagram: document.getElementById('editInstagram').value,
                        twitter: document.getElementById('editTwitter').value,
                        tiktok: document.getElementById('editTiktok').value,
                        youtube: document.getElementById('editYoutube').value,
                        twitch: document.getElementById('editTwitch').value
                    },
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                try {
                    await db.collection('users').doc(currentUser.uid).update(updates);
                    
                    // Update local userData
                    Object.assign(userData, updates);
                    
                    // Update UI
                    document.getElementById('dashboardName').textContent = displayName;
                    document.getElementById('userNav').textContent = displayName;
                    
                    showToast('Profile updated successfully!', 'success');
                    
                } catch (error) {
                    console.error('Error updating profile:', error);
                    showToast('Error updating profile. Please try again.', 'error');
                }
            });
            
            // Payment method change
            document.getElementById('paymentMethod').addEventListener('change', updatePaymentMethodFields);
            
            // Banking form submission
            document.getElementById('bankingForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const paymentMethod = document.getElementById('paymentMethod').value;
                const updates = {
                    paymentMethod: paymentMethod,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                // Add payment method specific fields
                if (paymentMethod === 'paypal') {
                    updates.paypalEmail = document.getElementById('paypalEmail').value;
                } else if (paymentMethod === 'bank') {
                    updates.bankName = document.getElementById('bankName').value;
                    updates.accountNumber = document.getElementById('accountNumber').value;
                    updates.routingNumber = document.getElementById('routingNumber').value;
                    updates.accountType = document.getElementById('accountType').value;
                }
                
                // Add tax ID if provided
                const taxId = document.getElementById('taxId').value;
                if (taxId) {
                    updates.taxId = taxId;
                }
                
                try {
                    await db.collection('users').doc(currentUser.uid).update(updates);
                    
                    // Update local userData
                    Object.assign(userData, updates);
                    
                    showToast('Banking information updated successfully!', 'success');
                    
                } catch (error) {
                    console.error('Error updating banking info:', error);
                    showToast('Error updating banking information', 'error');
                }
            });
            
            // Availability toggle
            const availabilityToggle = document.getElementById('availabilityToggle');
            if (availabilityToggle) {
                availabilityToggle.addEventListener('change', async function() {
                    const isAvailable = this.checked;
                    await updateWhisperAvailability(isAvailable);
                    userData.isAvailable = isAvailable;
                });
            }
            
            // Request payout button
            const requestPayoutBtn = document.getElementById('requestPayoutBtn');
            if (requestPayoutBtn) {
                requestPayoutBtn.addEventListener('click', async function() {
                    const availableEarnings = userData.earnings - (userData.pendingPayouts || 0);
                    
                    if (availableEarnings < 50) {
                        showToast(`Minimum payout is $50. You have $${availableEarnings.toFixed(2)} available.`, 'warning');
                        return;
                    }
                    
                    try {
                        // Create payout request
                        await db.collection('payouts').add({
                            userId: currentUser.uid,
                            amount: availableEarnings,
                            method: userData.paymentMethod || 'paypal',
                            status: 'pending',
                            requestedAt: firebase.firestore.FieldValue.serverTimestamp(),
                            referenceId: 'PAY-' + Date.now()
                        });
                        
                        // Update user's pending payouts
                        await db.collection('users').doc(currentUser.uid).update({
                            pendingPayouts: firebase.firestore.FieldValue.increment(availableEarnings),
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        
                        showToast(`Payout request for $${availableEarnings.toFixed(2)} submitted!`, 'success');
                        
                        // Reload earnings data
                        await loadEarningsData();
                        await loadPayoutHistory();
                        
                    } catch (error) {
                        console.error('Error requesting payout:', error);
                        showToast('Error requesting payout', 'error');
                    }
                });
            }
            
            // Load more calls button
            document.getElementById('loadMoreCalls').addEventListener('click', async function() {
                const spinner = this.querySelector('.fa-spinner');
                spinner.style.display = 'inline-block';
                this.disabled = true;
                
                await loadFullCallHistory(false);
                
                spinner.style.display = 'none';
                this.disabled = false;
            });
            
            // Call history filter
            document.getElementById('callHistoryFilter').addEventListener('change', function() {
                // In a real implementation, this would filter the call history
                showToast('Filtering call history...', 'info');
            });
            
            // Edit profile button
            document.getElementById('editProfileBtn').addEventListener('click', function() {
                document.querySelector('[data-tab="profile"]').click();
            });
            
            // View history button
            document.getElementById('viewHistoryBtn').addEventListener('click', function() {
                document.querySelector('[data-tab="calls"]').click();
            });
            
            // Invite friends button
            document.getElementById('inviteFriendsBtn').addEventListener('click', function() {
                const referralLink = `https://iaiwaf.com?ref=${currentUser.uid}`;
                navigator.clipboard.writeText(referralLink).then(() => {
                    showToast('Referral link copied to clipboard!', 'success');
                });
            });
            
            // Close modal buttons
            document.querySelectorAll('.modal-close').forEach(button => {
                button.addEventListener('click', function() {
                    this.closest('.modal').classList.remove('active');
                });
            });
            
            // Close modal when clicking outside
            document.addEventListener('click', function(event) {
                if (event.target.classList.contains('modal')) {
                    document.querySelectorAll('.modal').forEach(modal => {
                        modal.classList.remove('active');
                    });
                }
            });
        }
        
        // Update payment method fields
        function updatePaymentMethodFields() {
            const method = document.getElementById('paymentMethod').value;
            
            // Hide all fields
            document.getElementById('paypalFields').style.display = 'none';
            document.getElementById('bankFields').style.display = 'none';
            
            // Show relevant fields
            if (method === 'paypal') {
                document.getElementById('paypalFields').style.display = 'block';
            } else if (method === 'bank') {
                document.getElementById('bankFields').style.display = 'block';
            }
        }
        
        // View call details
        function viewCallDetails(callId) {
            // In a real implementation, this would show call details
            showToast('Opening call details...', 'info');
        }
        
        // Retry call
        function retryCall(whisperId) {
            startCallWithWhisper(whisperId);
        }
        
        // Download call data
        function downloadCallData(callId) {
            showToast('Downloading call data...', 'info');
        }
    </script>
</body>
</html>
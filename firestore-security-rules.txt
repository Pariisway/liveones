rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Users can read any user, but only write their own
    match /users/{userId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && request.auth.uid == userId;
      
      // Allow updating isAvailable for whispers (callers can update)
      allow update: if request.auth != null && 
                    (request.auth.uid == userId || 
                     request.resource.data.keys().hasOnly(['isAvailable']));
    }
    
    // Calls can be created by anyone, read by participants
    match /calls/{callId} {
      allow create: if request.auth != null;
      allow read: if request.auth != null && 
                   resource.data.participants.hasAny([request.auth.uid]);
      allow update: if request.auth != null && 
                   resource.data.participants.hasAny([request.auth.uid]);
    }
    
    // Active calls - same as calls
    match /activeCalls/{callId} {
      allow create: if request.auth != null;
      allow read, update: if request.auth != null && 
                          resource.data.participants.hasAny([request.auth.uid]);
    }
    
    // Transactions - users can read their own
    match /transactions/{transactionId} {
      allow create: if request.auth != null;
      allow read: if request.auth != null && 
                   resource.data.userId == request.auth.uid;
    }
    
    // Admin-only collections (we'll create these)
    match /admin/{document=**} {
      allow read, write: if request.auth != null && 
                         request.auth.uid in ["u3x8n3kY7QMWK8cVtXanL3FOIqo1", "V6NQDDxrokU2xCmCfmuPziMoXv82"];
    }
    
    // Disputes - users can create, admins can read
    match /disputes/{disputeId} {
      allow create: if request.auth != null;
      allow read: if request.auth != null && 
                  (resource.data.userId == request.auth.uid || 
                   request.auth.uid in ["u3x8n3kY7QMWK8cVtXanL3FOIqo1", "V6NQDDxrokU2xCmCfmuPziMoXv82"]);
    }
  }
}
